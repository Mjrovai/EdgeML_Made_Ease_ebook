<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.3.450">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>Edge AI Engineering - Experimenting with SLMs for IoT Control</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="../../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../../site_libs/clipboard/clipboard.min.js"></script>
<script src="../../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../../site_libs/quarto-search/fuse.min.js"></script>
<script src="../../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../../">
<link href="../../raspi/advancing_adgeai/adv_edgeai.html" rel="next">
<link href="../../raspi/physical_comp/RPi_Physical_Computing.html" rel="prev">
<link href="../../images/unifei-logo.png" rel="icon" type="image/png">
<script src="../../site_libs/quarto-html/quarto.js"></script>
<script src="../../site_libs/quarto-html/popper.min.js"></script>
<script src="../../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../../site_libs/quarto-html/anchor.min.js"></script>
<link href="../../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../../site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 20,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>


<link rel="stylesheet" href="../../styles.css">
</head>

<body class="nav-sidebar floating nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg navbar-dark ">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container">
    <a class="navbar-brand" href="../../index.html">
    <span class="navbar-title">Edge AI Engineering</span>
    </a>
  </div>
        <div class="quarto-navbar-tools ms-auto tools-wide">
    <a href="https://github.com/Mjrovai/EdgeML-with-Raspberry-Pi" rel="" title="Source Code" class="quarto-navigation-tool px-1" aria-label="Source Code"><i class="bi bi-github"></i></a>
    <a href="../../Edge-AI-Engineering.pdf" rel="" title="Download PDF" class="quarto-navigation-tool px-1" aria-label="Download PDF"><i class="bi bi-file-pdf"></i></a>
    <div class="dropdown">
      <a href="" title="Share" id="quarto-navigation-tool-dropdown-0" class="quarto-navigation-tool dropdown-toggle px-1" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Share"><i class="bi bi-share"></i></a>
      <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="quarto-navigation-tool-dropdown-0">
          <li>
            <a class="dropdown-item quarto-navbar-tools ms-auto-item" href="https://twitter.com/intent/tweet?url=|url|">
              <i class="bi bi-bi-twitter pe-1"></i>
            Twitter
            </a>
          </li>
          <li>
            <a class="dropdown-item quarto-navbar-tools ms-auto-item" href="https://www.linkedin.com/sharing/share-offsite/?url=|url|">
              <i class="bi bi-bi-linkedin pe-1"></i>
            LinkedIn
            </a>
          </li>
          <li>
            <a class="dropdown-item quarto-navbar-tools ms-auto-item" href="https://www.facebook.com/sharer/sharer.php?u=|url|">
              <i class="bi bi-bi-facebook pe-1"></i>
            Facebook
            </a>
          </li>
      </ul>
    </div>
  <a href="" class="quarto-reader-toggle quarto-navigation-tool px-1" onclick="window.quartoToggleReader(); return false;" title="Toggle reader mode">
  <div class="quarto-reader-toggle-btn">
  <i class="bi"></i>
  </div>
</a>
</div>
          <div id="quarto-search" class="" title="Search"></div>
      </div> <!-- /container-fluid -->
    </nav>
  <nav class="quarto-secondary-nav">
    <div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar,#quarto-sidebar-glass" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
      <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="../../raspi/iot/slm_iot.html">Experimenting with SLMs for IoT Control</a></li></ol></nav>
      <a class="flex-grow-1" role="button" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar,#quarto-sidebar-glass" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
      </a>
      <button type="button" class="btn quarto-search-button" aria-label="" onclick="window.quartoOpenSearch();">
        <i class="bi bi-search"></i>
      </button>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal sidebar-navigation floating overflow-auto">
        <div class="mt-2 flex-shrink-0 align-items-center">
        <div class="sidebar-search">
        <div id="quarto-search" class="" title="Search"></div>
        </div>
        </div>
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Preface</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../Acknowledgements.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Acknowledgments</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../intro.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Introduction</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../about_book.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">About this Book</span></a>
  </div>
</li>
        <li class="px-0"><hr class="sidebar-divider hi "></li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../Classification_of_AI_Applications.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Classification of AI Applications</span></a>
  </div>
</li>
        <li class="px-0"><hr class="sidebar-divider hi "></li>
        <li class="sidebar-item sidebar-item-section">
      <span class="sidebar-item-text sidebar-link text-start">
 <span class="menu-text"><div class="part">Fixed Function AI (Reactive)</div></span></span>
  </li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../raspi/setup/setup.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Setup</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../raspi/image_classification/image_classification_fund.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Image Classification Fundamentals</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../raspi/image_classification/custom_image_classification_project.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Custom Image Classification Project</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../raspi/object_detection/object_detection_fundamentals.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Object Detection: Fundamentals</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../raspi/object_detection/custom_object_detection.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Custom Object Detection Project</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../raspi/object_detection/cv_yolo.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Computer Vision Applications with YOLO</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../raspi/counting_objects_yolo/counting_objects_yolo.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Counting objects with YOLO</span></a>
  </div>
</li>
        <li class="sidebar-item sidebar-item-section">
      <span class="sidebar-item-text sidebar-link text-start">
 <span class="menu-text"><div class="part">Generative AI (Proactive)</div></span></span>
  </li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../raspi/rnn-verne/rnn-verne.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Text Generation with RNNs</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../raspi/kd_intro/kd_intro.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Knowledge Distillation in Practice</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../raspi/llm/slm_intro.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Small Language Models (SLM)</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../raspi/llm/slm_opt_tech.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">SLM: Basic Optimization Techniques</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../raspi/vlm/vlm.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Vision-Language Models at the Edge</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../raspi/audio_pipeline/audio_pipeline.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Audio and Vision AI Pipeline</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../raspi/physical_comp/RPi_Physical_Computing.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Physical Computing with Raspberry Pi</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../raspi/iot/slm_iot.html" class="sidebar-item-text sidebar-link active">
 <span class="menu-text">Experimenting with SLMs for IoT Control</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../raspi/advancing_adgeai/adv_edgeai.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Advancing EdgeAI: Beyond Basic SLMs</span></a>
  </div>
</li>
        <li class="px-0"><hr class="sidebar-divider hi "></li>
        <li class="sidebar-item sidebar-item-section">
      <span class="sidebar-item-text sidebar-link text-start">
 <span class="menu-text"><div class="part">Weekly Labs</div></span></span>
  </li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../weekly_labs.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Edge AI Engineering - Weekly Labs</span></a>
  </div>
</li>
        <li class="px-0"><hr class="sidebar-divider hi "></li>
        <li class="sidebar-item sidebar-item-section">
      <span class="sidebar-item-text sidebar-link text-start">
 <span class="menu-text"><div class="part">References &amp; Author</div></span></span>
  </li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../references.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">References</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../about_the_author.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">About the author</span></a>
  </div>
</li>
    </ul>
    </div>
</nav>
<div id="quarto-sidebar-glass" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar,#quarto-sidebar-glass"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">Table of contents</h2>
   
  <ul>
  <li><a href="#introduction" id="toc-introduction" class="nav-link active" data-scroll-target="#introduction">Introduction</a></li>
  <li><a href="#setup" id="toc-setup" class="nav-link" data-scroll-target="#setup">Setup</a>
  <ul>
  <li><a href="#hardware-setup" id="toc-hardware-setup" class="nav-link" data-scroll-target="#hardware-setup">Hardware Setup</a>
  <ul class="collapse">
  <li><a href="#connection-diagram" id="toc-connection-diagram" class="nav-link" data-scroll-target="#connection-diagram">Connection Diagram</a></li>
  </ul></li>
  <li><a href="#software-prerequisites" id="toc-software-prerequisites" class="nav-link" data-scroll-target="#software-prerequisites">Software Prerequisites</a></li>
  </ul></li>
  <li><a href="#basic-sensor-integration" id="toc-basic-sensor-integration" class="nav-link" data-scroll-target="#basic-sensor-integration">Basic Sensor Integration</a></li>
  <li><a href="#slm-basic-analysis" id="toc-slm-basic-analysis" class="nav-link" data-scroll-target="#slm-basic-analysis">SLM Basic Analysis</a>
  <ul>
  <li><a href="#act-on-output-actuators" id="toc-act-on-output-actuators" class="nav-link" data-scroll-target="#act-on-output-actuators">Act on Output (Actuators)</a></li>
  <li><a href="#creating-new-functions-for-the-actuation" id="toc-creating-new-functions-for-the-actuation" class="nav-link" data-scroll-target="#creating-new-functions-for-the-actuation">Creating new functions for the Actuation:</a></li>
  </ul></li>
  <li><a href="#prompting-engineering" id="toc-prompting-engineering" class="nav-link" data-scroll-target="#prompting-engineering">Prompting Engineering</a>
  <ul>
  <li><a href="#key-changes-in-the-code" id="toc-key-changes-in-the-code" class="nav-link" data-scroll-target="#key-changes-in-the-code">Key Changes in the code:</a></li>
  <li><a href="#system-overview-enhanced-iot-environmental-monitoring-with-slm-control" id="toc-system-overview-enhanced-iot-environmental-monitoring-with-slm-control" class="nav-link" data-scroll-target="#system-overview-enhanced-iot-environmental-monitoring-with-slm-control">System Overview: Enhanced IoT Environmental Monitoring with SLM Control</a>
  <ul class="collapse">
  <li><a href="#new-system-architecture" id="toc-new-system-architecture" class="nav-link" data-scroll-target="#new-system-architecture">New System Architecture</a></li>
  <li><a href="#hardware-components-layer" id="toc-hardware-components-layer" class="nav-link" data-scroll-target="#hardware-components-layer">1. <strong>Hardware Components Layer</strong></a></li>
  <li><a href="#hardware-interface-layer-monitor.py" id="toc-hardware-interface-layer-monitor.py" class="nav-link" data-scroll-target="#hardware-interface-layer-monitor.py">2. <strong>Hardware Interface Layer (monitor.py)</strong></a></li>
  <li><a href="#intelligence-layer-slm_act_leds.py" id="toc-intelligence-layer-slm_act_leds.py" class="nav-link" data-scroll-target="#intelligence-layer-slm_act_leds.py">3. <strong>Intelligence Layer (slm_act_leds.py)</strong></a></li>
  <li><a href="#how-it-works-a-complete-cycle" id="toc-how-it-works-a-complete-cycle" class="nav-link" data-scroll-target="#how-it-works-a-complete-cycle">How It Works: A Complete Cycle</a></li>
  <li><a href="#key-design-principles" id="toc-key-design-principles" class="nav-link" data-scroll-target="#key-design-principles">Key Design Principles</a></li>
  </ul></li>
  <li><a href="#the-new-code" id="toc-the-new-code" class="nav-link" data-scroll-target="#the-new-code">The new code</a></li>
  <li><a href="#code-flow-diagram" id="toc-code-flow-diagram" class="nav-link" data-scroll-target="#code-flow-diagram">Code Flow Diagram</a></li>
  <li><a href="#test1-temp-above-the-threshold" id="toc-test1-temp-above-the-threshold" class="nav-link" data-scroll-target="#test1-temp-above-the-threshold">TEST1: Temp above the threshold</a>
  <ul class="collapse">
  <li><a href="#definitions" id="toc-definitions" class="nav-link" data-scroll-target="#definitions">Definitions</a></li>
  <li><a href="#calling-the-program" id="toc-calling-the-program" class="nav-link" data-scroll-target="#calling-the-program">Calling the program</a></li>
  <li><a href="#result" id="toc-result" class="nav-link" data-scroll-target="#result">Result</a></li>
  </ul></li>
  <li><a href="#test2-temp-below-the-threshold" id="toc-test2-temp-below-the-threshold" class="nav-link" data-scroll-target="#test2-temp-below-the-threshold">TEST2: Temp below the threshold</a></li>
  <li><a href="#test3-alarm-button-pressed" id="toc-test3-alarm-button-pressed" class="nav-link" data-scroll-target="#test3-alarm-button-pressed">TEST3: Alarm Button pressed</a></li>
  </ul></li>
  <li><a href="#interacting-with-iot-systems-using-natural-language-commands" id="toc-interacting-with-iot-systems-using-natural-language-commands" class="nav-link" data-scroll-target="#interacting-with-iot-systems-using-natural-language-commands">Interacting with IoT Systems, using Natural Language Commands</a>
  <ul>
  <li><a href="#what-will-change" id="toc-what-will-change" class="nav-link" data-scroll-target="#what-will-change">What will change?</a>
  <ul class="collapse">
  <li><a href="#original-system-autonomous" id="toc-original-system-autonomous" class="nav-link" data-scroll-target="#original-system-autonomous">Original System (Autonomous)</a></li>
  <li><a href="#new-system-interactive" id="toc-new-system-interactive" class="nav-link" data-scroll-target="#new-system-interactive">New System (Interactive)</a></li>
  </ul></li>
  <li><a href="#how-it-will-work" id="toc-how-it-will-work" class="nav-link" data-scroll-target="#how-it-will-work">How It will Work</a>
  <ul class="collapse">
  <li><a href="#interactive-loop" id="toc-interactive-loop" class="nav-link" data-scroll-target="#interactive-loop">1. <strong>Interactive Loop</strong></a></li>
  <li><a href="#dual-purpose-response" id="toc-dual-purpose-response" class="nav-link" data-scroll-target="#dual-purpose-response">2. <strong>Dual-Purpose Response</strong></a></li>
  <li><a href="#command-types" id="toc-command-types" class="nav-link" data-scroll-target="#command-types">3. <strong>Command Types</strong></a></li>
  </ul></li>
  <li><a href="#key-functions" id="toc-key-functions" class="nav-link" data-scroll-target="#key-functions">Key Functions</a></li>
  <li><a href="#running-the-system" id="toc-running-the-system" class="nav-link" data-scroll-target="#running-the-system">Running the System</a></li>
  <li><a href="#tests" id="toc-tests" class="nav-link" data-scroll-target="#tests">Tests</a></li>
  <li><a href="#special-commands" id="toc-special-commands" class="nav-link" data-scroll-target="#special-commands">Special Commands</a></li>
  <li><a href="#languages" id="toc-languages" class="nav-link" data-scroll-target="#languages">Languages</a></li>
  <li><a href="#advantages-of-this-approach" id="toc-advantages-of-this-approach" class="nav-link" data-scroll-target="#advantages-of-this-approach">Advantages of This Approach</a></li>
  <li><a href="#error-handling" id="toc-error-handling" class="nav-link" data-scroll-target="#error-handling">Error Handling</a></li>
  <li><a href="#tips-for-best-results" id="toc-tips-for-best-results" class="nav-link" data-scroll-target="#tips-for-best-results">Tips for Best Results</a></li>
  <li><a href="#flow-diagram" id="toc-flow-diagram" class="nav-link" data-scroll-target="#flow-diagram">Flow Diagram</a></li>
  </ul></li>
  <li><a href="#adding-data-logging" id="toc-adding-data-logging" class="nav-link" data-scroll-target="#adding-data-logging">Adding Data Logging</a>
  <ul>
  <li><a href="#key-features" id="toc-key-features" class="nav-link" data-scroll-target="#key-features">Key Features</a>
  <ul class="collapse">
  <li><a href="#automatic-background-logging" id="toc-automatic-background-logging" class="nav-link" data-scroll-target="#automatic-background-logging">1. Automatic Background Logging</a></li>
  <li><a href="#csv-data-storage" id="toc-csv-data-storage" class="nav-link" data-scroll-target="#csv-data-storage">2. CSV Data Storage</a></li>
  <li><a href="#statistical-analysis" id="toc-statistical-analysis" class="nav-link" data-scroll-target="#statistical-analysis">3. Statistical Analysis</a></li>
  <li><a href="#natural-language-queries" id="toc-natural-language-queries" class="nav-link" data-scroll-target="#natural-language-queries">4. Natural Language Queries</a></li>
  </ul></li>
  <li><a href="#running-the-system-1" id="toc-running-the-system-1" class="nav-link" data-scroll-target="#running-the-system-1">Running the System</a></li>
  <li><a href="#example-queries" id="toc-example-queries" class="nav-link" data-scroll-target="#example-queries">Example Queries</a></li>
  <li><a href="#data-files" id="toc-data-files" class="nav-link" data-scroll-target="#data-files">Data Files</a></li>
  <li><a href="#sensor_readings.csv" id="toc-sensor_readings.csv" class="nav-link" data-scroll-target="#sensor_readings.csv">sensor_readings.csv</a></li>
  <li><a href="#command_history.csv" id="toc-command_history.csv" class="nav-link" data-scroll-target="#command_history.csv">command_history.csv</a></li>
  <li><a href="#tips" id="toc-tips" class="nav-link" data-scroll-target="#tips">Tips</a></li>
  <li><a href="#flow-diagram-1" id="toc-flow-diagram-1" class="nav-link" data-scroll-target="#flow-diagram-1">Flow Diagram</a></li>
  </ul></li>
  <li><a href="#prompt-optimization-and-efficiency" id="toc-prompt-optimization-and-efficiency" class="nav-link" data-scroll-target="#prompt-optimization-and-efficiency">Prompt Optimization and Efficiency</a>
  <ul>
  <li><a href="#quick-solution" id="toc-quick-solution" class="nav-link" data-scroll-target="#quick-solution">Quick Solution:</a>
  <ul class="collapse">
  <li><a href="#drastically-shorten-the-prompt" id="toc-drastically-shorten-the-prompt" class="nav-link" data-scroll-target="#drastically-shorten-the-prompt">1. Drastically Shorten the Prompt</a></li>
  <li><a href="#chat-api-instead-of-generate" id="toc-chat-api-instead-of-generate" class="nav-link" data-scroll-target="#chat-api-instead-of-generate">2. <code>chat</code> API Instead of <code>generate</code></a></li>
  <li><a href="#smart-context-management" id="toc-smart-context-management" class="nav-link" data-scroll-target="#smart-context-management">Smart Context Management</a></li>
  <li><a href="#model-pre-loading" id="toc-model-pre-loading" class="nav-link" data-scroll-target="#model-pre-loading">Model Pre-loading</a></li>
  </ul></li>
  <li><a href="#new-code" id="toc-new-code" class="nav-link" data-scroll-target="#new-code">New Code</a>
  <ul class="collapse">
  <li><a href="#original-functions" id="toc-original-functions" class="nav-link" data-scroll-target="#original-functions">Original Functions:</a></li>
  <li><a href="#new-functions" id="toc-new-functions" class="nav-link" data-scroll-target="#new-functions">New functions:</a></li>
  </ul></li>
  <li><a href="#key-changes-under-the-hood" id="toc-key-changes-under-the-hood" class="nav-link" data-scroll-target="#key-changes-under-the-hood">Key Changes Under the Hood:</a></li>
  <li><a href="#using-pydantic" id="toc-using-pydantic" class="nav-link" data-scroll-target="#using-pydantic">Using Pydantic</a>
  <ul class="collapse">
  <li><a href="#how-pydantic-reduces-latency-and-improves-reliability" id="toc-how-pydantic-reduces-latency-and-improves-reliability" class="nav-link" data-scroll-target="#how-pydantic-reduces-latency-and-improves-reliability">1. How Pydantic Reduces Latency and Improves Reliability</a></li>
  </ul></li>
  <li><a href="#implementing-pydantic-in-the-code" id="toc-implementing-pydantic-in-the-code" class="nav-link" data-scroll-target="#implementing-pydantic-in-the-code">2. Implementing Pydantic in the Code</a>
  <ul class="collapse">
  <li><a href="#step-1-define-the-pydantic-models" id="toc-step-1-define-the-pydantic-models" class="nav-link" data-scroll-target="#step-1-define-the-pydantic-models">Step 1: Define the Pydantic Models</a></li>
  <li><a href="#step-2-update-the-slm-inference-function" id="toc-step-2-update-the-slm-inference-function" class="nav-link" data-scroll-target="#step-2-update-the-slm-inference-function">Step 2: Update the SLM inference function</a></li>
  <li><a href="#step-3-update-the-parsing-function" id="toc-step-3-update-the-parsing-function" class="nav-link" data-scroll-target="#step-3-update-the-parsing-function">Step 3: Update the Parsing Function</a></li>
  </ul></li>
  </ul></li>
  <li><a href="#next-steps" id="toc-next-steps" class="nav-link" data-scroll-target="#next-steps">Next Steps</a></li>
  <li><a href="#conclusion" id="toc-conclusion" class="nav-link" data-scroll-target="#conclusion">Conclusion</a>
  <ul>
  <li><a href="#key-achievements" id="toc-key-achievements" class="nav-link" data-scroll-target="#key-achievements">Key Achievements</a></li>
  <li><a href="#challenges-and-limitations" id="toc-challenges-and-limitations" class="nav-link" data-scroll-target="#challenges-and-limitations">Challenges and Limitations</a></li>
  <li><a href="#final-thoughts" id="toc-final-thoughts" class="nav-link" data-scroll-target="#final-thoughts">Final Thoughts</a></li>
  <li><a href="#resourses" id="toc-resourses" class="nav-link" data-scroll-target="#resourses">Resourses</a></li>
  </ul></li>
  </ul>
<div class="toc-actions"><div><i class="bi bi-github"></i></div><div class="action-links"><p><a href="https://github.com/Mjrovai/EdgeML-with-Raspberry-Pi/edit/main/raspi/iot/slm_iot.qmd" class="toc-action">Edit this page</a></p><p><a href="https://github.com/Mjrovai/EdgeML-with-Raspberry-Pi/issues/new" class="toc-action">Report an issue</a></p><p><a href="https://github.com/Mjrovai/EdgeML-with-Raspberry-Pi/blob/main/raspi/iot/slm_iot.qmd" class="toc-action">View source</a></p></div></div></nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">Experimenting with SLMs for IoT Control</h1>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  

</header>

<p><img src="./images/jpeg/cover_iot.jpg" class="img-fluid"></p>
<section id="introduction" class="level2">
<h2 class="anchored" data-anchor-id="introduction">Introduction</h2>
<p>This chapter explores the implementation of Small Language Models (SLMs) in IoT control systems, demonstrating the possibility of creating a monitoring and control system using edge AI. We’ll integrate these models with physical sensors and actuators, creating an <strong>intelligent IoT system capable of natural language interaction</strong>. While this implementation shows the potential of integrating AI with physical systems, it also highlights current limitations and areas for improvement.</p>
<blockquote class="blockquote">
<p>This chapter builds on the concepts introduced in “Small Language Models (SLMs)” and “Physical Computing with Raspberry Pi.”</p>
</blockquote>
<p>The <strong>Physical Computing</strong> chapter laid the groundwork for interfacing with hardware components using the Raspberry Pi’s GPIO pins. We’ll revisit these concepts, focusing on connecting and interacting with sensors (DHT22 for temperature and humidity, BMP280 for temperature and pressure, and a push-button for digital inputs), as well as controlling actuators (LEDs) in a more sophisticated setup.</p>
<p>We will progress from a simple IoT system to a more advanced platform that combines real-time monitoring, historical data analysis, and natural language processing (NLP).</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="./images/png/block-sys.png" class="img-fluid figure-img" style="width:80.0%"></p>
</figure>
</div>
<p>This chapter demonstrates a progressive evolution through several key stages:</p>
<ol type="1">
<li>Basic Sensor Integration
<ul>
<li>Hardware interface with DHT22 (temperature/humidity) and BMP280 (temperature/pressure) sensors</li>
<li>Digital input through a push-button</li>
<li>Output control via RGB LEDs</li>
<li>Foundational data collection and device control</li>
</ul></li>
<li>SLM Basic Analysis
<ul>
<li>Initial integration with small language models</li>
<li>Simple observation and reporting of system state</li>
<li>Demonstration of SLM’s ability to interpret sensor data</li>
</ul></li>
<li>Active Control Implementation
<ul>
<li>Direct LED control based on SLM decisions</li>
<li>Temperature threshold monitoring</li>
<li>Emergency state detection via button input</li>
<li>Real-time system state analysis</li>
</ul></li>
<li>Natural Language Interaction
<ul>
<li>Free-form command interpretation</li>
<li>Context-aware responses</li>
<li>Multiple SLM model support</li>
<li>Flexible query handling</li>
</ul></li>
<li>Data Logging and Analysis
<ul>
<li>Continuous system state recording</li>
<li>Trend analysis and pattern detection</li>
<li>Historical data querying</li>
<li>Performance monitoring</li>
</ul></li>
</ol>
<p>Let’s begin by setting up our hardware and software environment, building upon the foundation established in our previous labs.</p>
</section>
<section id="setup" class="level2">
<h2 class="anchored" data-anchor-id="setup">Setup</h2>
<section id="hardware-setup" class="level3">
<h3 class="anchored" data-anchor-id="hardware-setup">Hardware Setup</h3>
<section id="connection-diagram" class="level4">
<h4 class="anchored" data-anchor-id="connection-diagram">Connection Diagram</h4>
<table class="table">
<thead>
<tr class="header">
<th>Component</th>
<th>GPIO Pin</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>DHT22</td>
<td>GPIO16</td>
</tr>
<tr class="even">
<td>BMP280 - SCL</td>
<td>GPIO03</td>
</tr>
<tr class="odd">
<td>BMP280 - SDA</td>
<td>GPIO02</td>
</tr>
<tr class="even">
<td>Red LED</td>
<td>GPIO13</td>
</tr>
<tr class="odd">
<td>Yellow LED</td>
<td>GPIO19</td>
</tr>
<tr class="even">
<td>Green LED</td>
<td>GPIO26</td>
</tr>
<tr class="odd">
<td>Button</td>
<td>GPIO20</td>
</tr>
</tbody>
</table>
<p><img src="./images/png/block_diagram.png" class="img-fluid"></p>
<ul>
<li>Raspberry Pi 5 (with an OS installed, as detailed in previous labs)</li>
<li>DHT22 temperature and humidity sensor</li>
<li>BMP280 temperature and pressure sensor</li>
<li>3 LEDs (red, yellow, green)</li>
<li>Push button</li>
<li>330Ω resistors (3)</li>
<li>Jumper wires and breadboard</li>
</ul>
</section>
</section>
<section id="software-prerequisites" class="level3">
<h3 class="anchored" data-anchor-id="software-prerequisites">Software Prerequisites</h3>
<ol type="1">
<li>Install required libraries:</li>
</ol>
<div class="sourceCode" id="cb1"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="ex">pip</span> install adafruit-circuitpython-dht </span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="ex">pip</span> install adafruit-circuitpython-bmp280</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
</section>
<section id="basic-sensor-integration" class="level2">
<h2 class="anchored" data-anchor-id="basic-sensor-integration">Basic Sensor Integration</h2>
<p>Let’s create a Python script (<code>monitor.py</code>) to handle the sensors and actuators. This script will contain functions to be called from other scripts later:</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> time</span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> board</span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> adafruit_dht</span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> adafruit_bmp280</span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> gpiozero <span class="im">import</span> LED, Button</span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a>DHT22Sensor <span class="op">=</span> adafruit_dht.DHT22(board.D16)</span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a>i2c <span class="op">=</span> board.I2C()</span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a>bmp280Sensor <span class="op">=</span> adafruit_bmp280.Adafruit_BMP280_I2C(i2c, address<span class="op">=</span><span class="bn">0x76</span>)</span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true" tabindex="-1"></a>bmp280Sensor.sea_level_pressure <span class="op">=</span> <span class="fl">1013.25</span></span>
<span id="cb2-11"><a href="#cb2-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-12"><a href="#cb2-12" aria-hidden="true" tabindex="-1"></a>ledRed <span class="op">=</span> LED(<span class="dv">13</span>)</span>
<span id="cb2-13"><a href="#cb2-13" aria-hidden="true" tabindex="-1"></a>ledYlw <span class="op">=</span> LED(<span class="dv">19</span>)</span>
<span id="cb2-14"><a href="#cb2-14" aria-hidden="true" tabindex="-1"></a>ledGrn <span class="op">=</span> LED(<span class="dv">26</span>)</span>
<span id="cb2-15"><a href="#cb2-15" aria-hidden="true" tabindex="-1"></a>button <span class="op">=</span> Button(<span class="dv">20</span>)</span>
<span id="cb2-16"><a href="#cb2-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-17"><a href="#cb2-17" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> collect_data():</span>
<span id="cb2-18"><a href="#cb2-18" aria-hidden="true" tabindex="-1"></a>    <span class="cf">try</span>:</span>
<span id="cb2-19"><a href="#cb2-19" aria-hidden="true" tabindex="-1"></a>        temperature_dht <span class="op">=</span> DHT22Sensor.temperature</span>
<span id="cb2-20"><a href="#cb2-20" aria-hidden="true" tabindex="-1"></a>        humidity <span class="op">=</span> DHT22Sensor.humidity</span>
<span id="cb2-21"><a href="#cb2-21" aria-hidden="true" tabindex="-1"></a>        temperature_bmp <span class="op">=</span> bmp280Sensor.temperature</span>
<span id="cb2-22"><a href="#cb2-22" aria-hidden="true" tabindex="-1"></a>        pressure <span class="op">=</span> bmp280Sensor.pressure</span>
<span id="cb2-23"><a href="#cb2-23" aria-hidden="true" tabindex="-1"></a>        button_pressed <span class="op">=</span> button.is_pressed</span>
<span id="cb2-24"><a href="#cb2-24" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> temperature_dht, humidity, temperature_bmp, pressure, button_pressed</span>
<span id="cb2-25"><a href="#cb2-25" aria-hidden="true" tabindex="-1"></a>    <span class="cf">except</span> <span class="pp">RuntimeError</span>:</span>
<span id="cb2-26"><a href="#cb2-26" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="va">None</span>, <span class="va">None</span>, <span class="va">None</span>, <span class="va">None</span>, <span class="va">None</span></span>
<span id="cb2-27"><a href="#cb2-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-28"><a href="#cb2-28" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> led_status():</span>
<span id="cb2-29"><a href="#cb2-29" aria-hidden="true" tabindex="-1"></a>    ledRedSts <span class="op">=</span> ledRed.is_lit</span>
<span id="cb2-30"><a href="#cb2-30" aria-hidden="true" tabindex="-1"></a>    ledYlwSts <span class="op">=</span> ledYlw.is_lit</span>
<span id="cb2-31"><a href="#cb2-31" aria-hidden="true" tabindex="-1"></a>    ledGrnSts <span class="op">=</span> ledGrn.is_lit </span>
<span id="cb2-32"><a href="#cb2-32" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> ledRedSts, ledYlwSts, ledGrnSts</span>
<span id="cb2-33"><a href="#cb2-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-34"><a href="#cb2-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-35"><a href="#cb2-35" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> control_leds(red, yellow, green):</span>
<span id="cb2-36"><a href="#cb2-36" aria-hidden="true" tabindex="-1"></a>    ledRed.on() <span class="cf">if</span> red <span class="cf">else</span> ledRed.off()</span>
<span id="cb2-37"><a href="#cb2-37" aria-hidden="true" tabindex="-1"></a>    ledYlw.on() <span class="cf">if</span> yellow <span class="cf">else</span> ledYlw.off()</span>
<span id="cb2-38"><a href="#cb2-38" aria-hidden="true" tabindex="-1"></a>    ledGrn.on() <span class="cf">if</span> green <span class="cf">else</span> ledGrn.off()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>We can test the functions using:</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="cf">while</span> <span class="va">True</span>:</span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>    ledRedSts, ledYlwSts, ledGrnSts  <span class="op">=</span> led_status()</span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a>    temp_dht, hum, temp_bmp, press, button_state  <span class="op">=</span> collect_data()</span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a>    <span class="co">#control_leds(True, True, True)</span></span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="bu">all</span>(v <span class="kw">is</span> <span class="kw">not</span> <span class="va">None</span> <span class="cf">for</span> v <span class="kw">in</span> [temp_dht, hum, temp_bmp, press]):</span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"DHT22 Temp: </span><span class="sc">{</span>temp_dht<span class="sc">:.1f}</span><span class="ss">°C, Humidity: </span><span class="sc">{</span>hum<span class="sc">:.1f}</span><span class="ss">%"</span>)</span>
<span id="cb3-9"><a href="#cb3-9" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"BMP280 Temp: </span><span class="sc">{</span>temp_bmp<span class="sc">:.1f}</span><span class="ss">°C, Pressure: </span><span class="sc">{</span>press<span class="sc">:.2f}</span><span class="ss">hPa"</span>)</span>
<span id="cb3-10"><a href="#cb3-10" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"Button </span><span class="sc">{</span><span class="st">'pressed'</span> <span class="cf">if</span> button_state <span class="cf">else</span> <span class="st">'not pressed'</span><span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb3-11"><a href="#cb3-11" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"Red LED </span><span class="sc">{</span><span class="st">'is on'</span> <span class="cf">if</span> ledRedSts <span class="cf">else</span> <span class="st">'is off'</span><span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb3-12"><a href="#cb3-12" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"Yellow LED </span><span class="sc">{</span><span class="st">'is on'</span> <span class="cf">if</span> ledYlwSts <span class="cf">else</span> <span class="st">'is off'</span><span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb3-13"><a href="#cb3-13" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"Green LED </span><span class="sc">{</span><span class="st">'is on'</span> <span class="cf">if</span> ledGrnSts <span class="cf">else</span> <span class="st">'is off'</span><span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb3-14"><a href="#cb3-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-15"><a href="#cb3-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-16"><a href="#cb3-16" aria-hidden="true" tabindex="-1"></a>    time.sleep(<span class="dv">2</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p><img src="./images/png/monitor.png" class="img-fluid"></p>
</section>
<section id="slm-basic-analysis" class="level2">
<h2 class="anchored" data-anchor-id="slm-basic-analysis">SLM Basic Analysis</h2>
<p>Now, let’s create a new script, <code>slm_basic_analysis.py</code>, which will be responsible for analysing the hardware components’ status, according to the following diagram:</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="./images/png/slm_basic_analysis_sw_diagram.png" class="img-fluid figure-img" style="width:80.0%"></p>
</figure>
</div>
<p>The diagram shows the basic analysis system, which consists of:</p>
<ol type="1">
<li><strong>Hardware Layer</strong>:
<ul>
<li>Sensors: DHT22 (temperature/humidity), BMP280 (temperature/pressure)</li>
<li>Input: Emergency button</li>
<li>Output: Three LEDs (Red, Yellow, Green)</li>
</ul></li>
<li><strong><a href="https://github.com/Mjrovai/EdgeML-with-Raspberry-Pi/blob/main/SLMs_for_IoT_CONTROL/monitor.py">monitor.py</a></strong>:
<ul>
<li>Handles all hardware interactions</li>
<li>Provides two main functions:
<ul>
<li><code>collect_data()</code>: Reads all sensor values</li>
<li><code>led_status()</code>: Checks current LED states</li>
</ul></li>
</ul></li>
<li><strong><a href="https://github.com/Mjrovai/EdgeML-with-Raspberry-Pi/blob/main/SLMs_for_IoT_CONTROL/slm_basic_analysis.py">slm_basic_analysis.py</a></strong>:
<ul>
<li>Creates a descriptive prompt using sensor data</li>
<li>Sends prompt to SLM (for example, the <code>Llama 3.2 1B</code>)</li>
<li>Displays analysis results</li>
<li>In this step we will not control the LEDs (observation only)</li>
</ul></li>
</ol>
<p>Okay, let’s implement the code, starting for importing the Ollama library and the functions to monitor the HW (from the previous script):</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> ollama</span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> monitor <span class="im">import</span> collect_data, led_status</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Calling the monitor functions, we will get all data:</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a>ledRedSts, ledYlwSts, ledGrnSts  <span class="op">=</span> led_status()</span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a>temp_dht, hum, temp_bmp, press, button_state  <span class="op">=</span> collect_data()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Now, the heart of out code, we will <strong>generate the Prompt</strong>, using the data captured on the previous variables:</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a>prompt <span class="op">=</span> <span class="ss">f"""</span></span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a><span class="ss">        You are an experienced environmental scientist. </span></span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a><span class="ss">        Analyze the information received from an IoT system:</span></span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a><span class="ss">        DHT22 Temp: </span><span class="sc">{</span>temp_dht<span class="sc">:.1f}</span><span class="ss">°C and Humidity: </span><span class="sc">{</span>hum<span class="sc">:.1f}</span><span class="ss">%</span></span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a><span class="ss">        BMP280 Temp: </span><span class="sc">{</span>temp_bmp<span class="sc">:.1f}</span><span class="ss">°C and Pressure: </span><span class="sc">{</span>press<span class="sc">:.2f}</span><span class="ss">hPa</span></span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a><span class="ss">        Button </span><span class="sc">{</span><span class="st">"pressed"</span> <span class="cf">if</span> button_state <span class="cf">else</span> <span class="st">"not pressed"</span><span class="sc">}</span></span>
<span id="cb6-8"><a href="#cb6-8" aria-hidden="true" tabindex="-1"></a><span class="ss">        Red LED </span><span class="sc">{</span><span class="st">"is on"</span> <span class="cf">if</span> ledRedSts <span class="cf">else</span> <span class="st">"is off"</span><span class="sc">}</span></span>
<span id="cb6-9"><a href="#cb6-9" aria-hidden="true" tabindex="-1"></a><span class="ss">        Yellow LED </span><span class="sc">{</span><span class="st">"is on"</span> <span class="cf">if</span> ledYlwSts <span class="cf">else</span> <span class="st">"is off"</span><span class="sc">}</span></span>
<span id="cb6-10"><a href="#cb6-10" aria-hidden="true" tabindex="-1"></a><span class="ss">        Green LED </span><span class="sc">{</span><span class="st">"is on"</span> <span class="cf">if</span> ledGrnSts <span class="cf">else</span> <span class="st">"is off"</span><span class="sc">}</span></span>
<span id="cb6-11"><a href="#cb6-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-12"><a href="#cb6-12" aria-hidden="true" tabindex="-1"></a><span class="ss">        Where,</span></span>
<span id="cb6-13"><a href="#cb6-13" aria-hidden="true" tabindex="-1"></a><span class="ss">        - The button, not pressed, shows a normal operation</span></span>
<span id="cb6-14"><a href="#cb6-14" aria-hidden="true" tabindex="-1"></a><span class="ss">        - The button, when pressed, shows an emergency</span></span>
<span id="cb6-15"><a href="#cb6-15" aria-hidden="true" tabindex="-1"></a><span class="ss">        - Red LED when is on, indicates a problem/emergency.</span></span>
<span id="cb6-16"><a href="#cb6-16" aria-hidden="true" tabindex="-1"></a><span class="ss">        - Yellow LED when is on indicates a warning situation.</span></span>
<span id="cb6-17"><a href="#cb6-17" aria-hidden="true" tabindex="-1"></a><span class="ss">        - Green LED when is on, indicates system is OK.</span></span>
<span id="cb6-18"><a href="#cb6-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-19"><a href="#cb6-19" aria-hidden="true" tabindex="-1"></a><span class="ss">        If the temperature is over 20°C, mean a warning situation</span></span>
<span id="cb6-20"><a href="#cb6-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-21"><a href="#cb6-21" aria-hidden="true" tabindex="-1"></a><span class="ss">        You should answer only with: "Activate Red LED" or </span></span>
<span id="cb6-22"><a href="#cb6-22" aria-hidden="true" tabindex="-1"></a><span class="ss">        "Activate Yellow LED" or "Activate Green LED"</span></span>
<span id="cb6-23"><a href="#cb6-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-24"><a href="#cb6-24" aria-hidden="true" tabindex="-1"></a><span class="ss">"""</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Now, the Prompt will be passed to the SLM, which will generate a <code>response</code>:</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a>MODEL <span class="op">=</span> <span class="st">'llama3.2:3b'</span></span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a>PROMPT <span class="op">=</span> prompt</span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a>response <span class="op">=</span> ollama.generate(</span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a>    model<span class="op">=</span>MODEL, </span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a>    prompt<span class="op">=</span>PROMPT</span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a>    )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>The last stage will be show the real monitored data and the SLM’s response:</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss">Smart IoT Analyser using </span><span class="sc">{</span>MODEL<span class="sc">}</span><span class="ss"> model</span><span class="ch">\n</span><span class="ss">"</span>)</span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"SYSTEM REAL DATA"</span>)</span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f" - DHT22 ==&gt; Temp: </span><span class="sc">{</span>temp_dht<span class="sc">:.1f}</span><span class="ss">°C, Humidity: </span><span class="sc">{</span>hum<span class="sc">:.1f}</span><span class="ss">%"</span>)</span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f" - BMP280 =&gt; Temp: </span><span class="sc">{</span>temp_bmp<span class="sc">:.1f}</span><span class="ss">°C, Pressure: </span><span class="sc">{</span>press<span class="sc">:.2f}</span><span class="ss">hPa"</span>)</span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f" - Button </span><span class="sc">{</span><span class="st">'pressed'</span> <span class="cf">if</span> button_state <span class="cf">else</span> <span class="st">'not pressed'</span><span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb8-7"><a href="#cb8-7" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f" - Red LED </span><span class="sc">{</span><span class="st">'is on'</span> <span class="cf">if</span> ledRedSts <span class="cf">else</span> <span class="st">'is off'</span><span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb8-8"><a href="#cb8-8" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f" - Yellow LED </span><span class="sc">{</span><span class="st">'is on'</span> <span class="cf">if</span> ledYlwSts <span class="cf">else</span> <span class="st">'is off'</span><span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb8-9"><a href="#cb8-9" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f" - Green LED </span><span class="sc">{</span><span class="st">'is on'</span> <span class="cf">if</span> ledGrnSts <span class="cf">else</span> <span class="st">'is off'</span><span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb8-10"><a href="#cb8-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-11"><a href="#cb8-11" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss">&gt;&gt; </span><span class="sc">{</span>MODEL<span class="sc">}</span><span class="ss"> Response: </span><span class="sc">{</span>response[<span class="st">'response'</span>]<span class="sc">}</span><span class="ss">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Runing the Python script, we got:</p>
<p><img src="./images/png/slm_analysis.png" class="img-fluid"></p>
<p>In this initial experiment, the system successfully collected sensor data (temperatures of 26.3°C and 26.1°C from DHT22 and BMP280, respectively, 40.2% humidity, and 908.84hPa pressure) and processed this information through the SLM, which produced a coherent response recommending the activation of the yellow LED due to elevated temperature conditions.</p>
<p>The model’s ability to interpret sensor data and provide logical, rule-based decisions shows promise. Still, the simplistic nature of the current implementation (using basic thresholds and binary LED outputs) suggests significant room for improvement through more sophisticated prompting strategies, historical data integration, and the implementation of safety mechanisms. Also, the result is probabilistic, meaning it should change after execution.</p>
<section id="act-on-output-actuators" class="level3">
<h3 class="anchored" data-anchor-id="act-on-output-actuators">Act on Output (Actuators)</h3>
<p>Let’s use the output generated and use it to actuate on the LEDs, our “actuators”:</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="./images/png/act.png" class="img-fluid figure-img" style="width:90.0%"></p>
</figure>
</div>
<p>We can add a new function, <code>parse_llm_response(),</code> to return a command to the the LEDs based on the SLM’s response:</p>
<div class="sourceCode" id="cb9"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> parse_llm_response(response_text):</span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Parse the LLM response to extract LED control instructions."""</span></span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a>    response_lower <span class="op">=</span> response_text.lower()</span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a>    red_led <span class="op">=</span> <span class="st">'activate red led'</span> <span class="kw">in</span> response_lower</span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a>    yellow_led <span class="op">=</span> <span class="st">'activate yellow led'</span> <span class="kw">in</span> response_lower</span>
<span id="cb9-6"><a href="#cb9-6" aria-hidden="true" tabindex="-1"></a>    green_led <span class="op">=</span> <span class="st">'activate green led'</span> <span class="kw">in</span> response_lower</span>
<span id="cb9-7"><a href="#cb9-7" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> (red_led, yellow_led, green_led)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>The return to this function:</p>
<div class="sourceCode" id="cb10"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a>red, yellow, green <span class="op">=</span> parse_llm_response(response[<span class="st">'response'</span>])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Would be:<code>(False, True, False)</code>, which can be the input to the function <code>control_leds(red, yellow, green)'</code></p>
<div class="sourceCode" id="cb11"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a>control_leds(red, yellow, green)</span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a>led_status()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p><code>(False, True, False)</code></p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="./images/png/act-yellow.png" class="img-fluid figure-img" style="width:60.0%"></p>
</figure>
</div>
</section>
<section id="creating-new-functions-for-the-actuation" class="level3">
<h3 class="anchored" data-anchor-id="creating-new-functions-for-the-actuation">Creating new functions for the Actuation:</h3>
<p>One for the inference:</p>
<div class="sourceCode" id="cb12"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> slm_inference(PROMPT, MODEL):</span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a>    response <span class="op">=</span> ollama.generate(</span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a>        model<span class="op">=</span>MODEL, </span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a>        prompt<span class="op">=</span>PROMPT</span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb12-6"><a href="#cb12-6" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> response</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>And another for output analysis and actuation:</p>
<div class="sourceCode" id="cb13"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> output_actuator(response, MODEL):</span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss">Smart IoT Actuator using </span><span class="sc">{</span>MODEL<span class="sc">}</span><span class="ss"> model</span><span class="ch">\n</span><span class="ss">"</span>)</span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"SYSTEM REAL DATA"</span>)</span>
<span id="cb13-5"><a href="#cb13-5" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f" - DHT22 ==&gt; Temp: </span><span class="sc">{</span>temp_dht<span class="sc">:.1f}</span><span class="ss">°C, Humidity: </span><span class="sc">{</span>hum<span class="sc">:.1f}</span><span class="ss">%"</span>)</span>
<span id="cb13-6"><a href="#cb13-6" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f" - BMP280 =&gt; Temp: </span><span class="sc">{</span>temp_bmp<span class="sc">:.1f}</span><span class="ss">°C, Pressure: </span><span class="sc">{</span>press<span class="sc">:.2f}</span><span class="ss">hPa"</span>)</span>
<span id="cb13-7"><a href="#cb13-7" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f" - Button </span><span class="sc">{</span><span class="st">'pressed'</span> <span class="cf">if</span> button_state <span class="cf">else</span> <span class="st">'not pressed'</span><span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb13-8"><a href="#cb13-8" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb13-9"><a href="#cb13-9" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss">&gt;&gt; </span><span class="sc">{</span>MODEL<span class="sc">}</span><span class="ss"> Response: </span><span class="sc">{</span>response[<span class="st">'response'</span>]<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb13-10"><a href="#cb13-10" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb13-11"><a href="#cb13-11" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Control LEDs based on response</span></span>
<span id="cb13-12"><a href="#cb13-12" aria-hidden="true" tabindex="-1"></a>    red, yellow, green <span class="op">=</span> parse_llm_response(response[<span class="st">'response'</span>])</span>
<span id="cb13-13"><a href="#cb13-13" aria-hidden="true" tabindex="-1"></a>    control_leds(red, yellow, green)</span>
<span id="cb13-14"><a href="#cb13-14" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb13-15"><a href="#cb13-15" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss">SYSTEM ACTUATOR STATUS"</span>)</span>
<span id="cb13-16"><a href="#cb13-16" aria-hidden="true" tabindex="-1"></a>    ledRedSts, ledYlwSts, ledGrnSts  <span class="op">=</span> led_status()</span>
<span id="cb13-17"><a href="#cb13-17" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f" - Red LED </span><span class="sc">{</span><span class="st">'is on'</span> <span class="cf">if</span> ledRedSts <span class="cf">else</span> <span class="st">'is off'</span><span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb13-18"><a href="#cb13-18" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f" - Yellow LED </span><span class="sc">{</span><span class="st">'is on'</span> <span class="cf">if</span> ledYlwSts <span class="cf">else</span> <span class="st">'is off'</span><span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb13-19"><a href="#cb13-19" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f" - Green LED </span><span class="sc">{</span><span class="st">'is on'</span> <span class="cf">if</span> ledGrnSts <span class="cf">else</span> <span class="st">'is off'</span><span class="sc">}</span><span class="ss">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>By updating the system and calling the two functions in sequence, we can have the full cycle of analysis by the SLM and the actuation on the output LEDs:</p>
<div class="sourceCode" id="cb14"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a>ledRedSts, ledYlwSts, ledGrnSts  <span class="op">=</span> led_status()</span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a>temp_dht, hum, temp_bmp, press, button_state  <span class="op">=</span> collect_data()</span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a>response <span class="op">=</span> slm_inference(PROMPT, MODEL)</span>
<span id="cb14-5"><a href="#cb14-5" aria-hidden="true" tabindex="-1"></a>output_actuator(response, MODEL)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<blockquote class="blockquote">
<p>The new script can be found on GitHub: <a href="https://github.com/Mjrovai/EdgeML-with-Raspberry-Pi/blob/main/SLMs_for_IoT_CONTROL/slm_basic_act_leds.py">slm_basic_act_leds</a>.</p>
</blockquote>
<p>Let’s press the button, call the functions, and see what happens:</p>
<div class="sourceCode" id="cb15"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a>ledRedSts, ledYlwSts, ledGrnSts  <span class="op">=</span> led_status()</span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a>temp_dht, hum, temp_bmp, press, button_state  <span class="op">=</span> collect_data()</span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a>response <span class="op">=</span> slm_inference(PROMPT, MODEL)</span>
<span id="cb15-4"><a href="#cb15-4" aria-hidden="true" tabindex="-1"></a>output_actuator(response, MODEL)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p><img src="./images/png/button-issue.png" class="img-fluid"></p>
<p>We can see that, despite the button being pressed, the SLM did not consider it and misinterpreted the temperature value as ABOVE the threshold, not below. Also, despite the fact that we asked for a straight answer about which LED to turn on, the model lost time with analysis,</p>
<p>This issue relates to the prompt we wrote. Let’s cover it in the next section.</p>
</section>
</section>
<section id="prompting-engineering" class="level2">
<h2 class="anchored" data-anchor-id="prompting-engineering">Prompting Engineering</h2>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="./images/png/analysis_act_slm_system.png" class="img-fluid figure-img" style="width:80.0%"></p>
</figure>
</div>
<p>Looking at the answers we got with the previous implementation, which are not always correct, we can see that the main issue is <strong>unreliable text parsing</strong>. Using JSON to parse the answer should be much better!</p>
<section id="key-changes-in-the-code" class="level3">
<h3 class="anchored" data-anchor-id="key-changes-in-the-code">Key Changes in the code:</h3>
<ol type="1">
<li><p><strong>Added JSON import</strong></p></li>
<li><p><strong>Fixed variable scope bug</strong> - The previous code tried to use <code>temp_dht</code>, <code>hum</code>, etc. in the prompt <em>before</em> they were defined. The prompt is now created in a function after receiving sensor data.</p></li>
<li><p><strong>Changed to JSON format</strong> - The prompt now asks for a structured JSON response:</p>
<div class="sourceCode" id="cb16"><pre class="sourceCode json code-with-copy"><code class="sourceCode json"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a><span class="fu">{</span><span class="dt">"red_led"</span><span class="fu">:</span> <span class="kw">true</span><span class="fu">,</span> <span class="dt">"yellow_led"</span><span class="fu">:</span> <span class="kw">false</span><span class="fu">,</span> <span class="dt">"green_led"</span><span class="fu">:</span> <span class="kw">false</span><span class="fu">}</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div></li>
<li><p><strong>Updated parser</strong> - Now parses JSON instead of searching for text strings. Includes error handling and fallback to safe state (all LEDs off) if parsing fails.</p></li>
</ol>
<blockquote class="blockquote">
<p><strong>Why JSON is Better:</strong></p>
<ul>
<li><strong>More reliable</strong>: No ambiguity about which LEDs to activate</li>
<li><strong>Structured</strong>: Clear true/false values instead of parsing text</li>
<li><strong>Error-resistant</strong>: The parser handles markdown code blocks (some models wrap JSON in ```) and provides safe fallback</li>
<li><strong>Flexible</strong>: Easy to add more fields later if needed</li>
</ul>
</blockquote>
<p>Let’s revise the previous code, with a better prompt and parcing funcion, now based on JSON.</p>
</section>
<section id="system-overview-enhanced-iot-environmental-monitoring-with-slm-control" class="level3">
<h3 class="anchored" data-anchor-id="system-overview-enhanced-iot-environmental-monitoring-with-slm-control">System Overview: Enhanced IoT Environmental Monitoring with SLM Control</h3>
<p>This project demonstrates how a Small Language Model (SLM) can make intelligent decisions in an IoT system. The system monitors environmental conditions using sensors and controls LED indicators based on the SLM’s analysis.</p>
<section id="new-system-architecture" class="level4">
<h4 class="anchored" data-anchor-id="new-system-architecture">New System Architecture</h4>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="./images/png/iot-slm-system-arquiteture.png" class="img-fluid figure-img" style="width:90.0%"></p>
</figure>
</div>
<p>The system is organized into three main layers:</p>
</section>
<section id="hardware-components-layer" class="level4">
<h4 class="anchored" data-anchor-id="hardware-components-layer">1. <strong>Hardware Components Layer</strong></h4>
<p>The physical layer consists of:</p>
<ul>
<li><strong>DHT22 Sensor</strong>: Measures temperature and humidity</li>
<li><strong>BMP280 Sensor</strong>: Measures temperature and atmospheric pressure</li>
<li><strong>Emergency Button</strong>: Manual override for emergency situations</li>
<li><strong>Three LEDs</strong>: Visual indicators
<ul>
<li><strong>Red LED</strong>: Emergency/Problem state</li>
<li><strong>Yellow LED</strong>: Warning state</li>
<li><strong>Green LED</strong>: Normal operation</li>
</ul></li>
</ul>
</section>
<section id="hardware-interface-layer-monitor.py" class="level4">
<h4 class="anchored" data-anchor-id="hardware-interface-layer-monitor.py">2. <strong>Hardware Interface Layer (<a href="https://github.com/Mjrovai/EdgeML-with-Raspberry-Pi/blob/main/SLMs_for_IoT_CONTROL/monitor.py">monitor.py</a>)</strong></h4>
<p>This layer provides the bridge between hardware and software with three key functions:</p>
<ul>
<li><strong><code>collect_data()</code></strong>: Reads all sensor values (temperature, humidity, pressure) and button state</li>
<li><strong><code>led_status()</code></strong>: Checks the current state of all LEDs</li>
<li><strong><code>control_leds(red, yellow, green)</code></strong>: Controls which LED is turned on based on boolean values</li>
</ul>
</section>
<section id="intelligence-layer-slm_act_leds.py" class="level4">
<h4 class="anchored" data-anchor-id="intelligence-layer-slm_act_leds.py">3. <strong>Intelligence Layer (<a href="https://github.com/Mjrovai/EdgeML-with-Raspberry-Pi/blob/main/SLMs_for_IoT_CONTROL/slm_act_leds.py">slm_act_leds.py</a>)</strong></h4>
<p>This is where the SLM makes decisions. The workflow follows these steps:</p>
<p><strong>a) Data Collection &amp; Preparation</strong></p>
<ul>
<li><strong><code>slm_analyse_act(MODEL, TEMP_THRESHOLD)</code></strong>: Main function that orchestrates the entire process
<ul>
<li>Calls <code>collect_data()</code> to get current sensor readings</li>
<li>Calls <code>led_status()</code> to check LED states</li>
</ul></li>
</ul>
<p><strong>b) Prompt Generation</strong></p>
<ul>
<li><strong><code>create_prompt()</code></strong>: Builds a detailed prompt for the SLM, including:
<ul>
<li>Current sensor readings</li>
<li>Temperature threshold value</li>
<li>Decision rules with clear priorities:
<ol type="1">
<li>Button pressed → Red LED (Emergency - highest priority)</li>
<li>Temperature exceeds threshold → Yellow LED (Warning)</li>
<li>Normal conditions → Green LED (All OK)</li>
</ol></li>
<li>Pre-analyzed data to help the SLM understand the current state</li>
</ul></li>
</ul>
<p><strong>c) SLM Inference</strong></p>
<ul>
<li><strong><code>slm_inference(PROMPT, MODEL)</code></strong>: Sends the prompt to the Ollama SLM (llama3.2:3b or any other SLM, as Gemma or Phi)</li>
<li>The SLM analyzes the situation and returns a <strong>JSON response</strong>:</li>
</ul>
<div class="sourceCode" id="cb17"><pre class="sourceCode json code-with-copy"><code class="sourceCode json"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a><span class="fu">{</span></span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a>  <span class="dt">"red_led"</span><span class="fu">:</span> <span class="kw">false</span><span class="fu">,</span></span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a>  <span class="dt">"yellow_led"</span><span class="fu">:</span> <span class="kw">false</span><span class="fu">,</span></span>
<span id="cb17-4"><a href="#cb17-4" aria-hidden="true" tabindex="-1"></a>  <span class="dt">"green_led"</span><span class="fu">:</span> <span class="kw">true</span></span>
<span id="cb17-5"><a href="#cb17-5" aria-hidden="true" tabindex="-1"></a><span class="fu">}</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p><strong>d) Response Processing</strong></p>
<ul>
<li><strong><code>parse_llm_response()</code></strong>: Parses the JSON response from the SLM
<ul>
<li>Handles edge cases like markdown code blocks</li>
<li>Extracts boolean values for each LED</li>
<li>Returns a tuple: <code>(red, yellow, green)</code></li>
</ul></li>
</ul>
<p><strong>e) Actuation</strong></p>
<ul>
<li><strong><code>output_actuator()</code></strong>: Takes the SLM’s decision and executes it
<ul>
<li>Displays all sensor data</li>
<li>Shows the SLM’s JSON response</li>
<li>Shows the final decision</li>
<li>Calls <code>control_leds()</code> to physically turn LEDs on/off</li>
<li>Displays final LED status for verification</li>
</ul></li>
</ul>
</section>
<section id="how-it-works-a-complete-cycle" class="level4">
<h4 class="anchored" data-anchor-id="how-it-works-a-complete-cycle">How It Works: A Complete Cycle</h4>
<ol type="1">
<li><strong>Sensors continuously monitor</strong> the environment (temperature, humidity, pressure, button state)</li>
<li><strong>Data flows</strong> from hardware through <code>monitor.py</code> to <code>slm_act_leds.py</code></li>
<li><strong>The SLM receives</strong> a structured prompt with current conditions and decision rules</li>
<li><strong>The SLM analyzes</strong> the data and decides which LED should be activated</li>
<li><strong>The decision returns</strong> as a JSON object specifying exactly which LED to turn on</li>
<li><strong>The system executes</strong> the decision by controlling the LEDs through <code>monitor.py</code></li>
<li><strong>Visual feedback</strong> is provided via the LED, and the system logs all data and decisions</li>
</ol>
</section>
<section id="key-design-principles" class="level4">
<h4 class="anchored" data-anchor-id="key-design-principles">Key Design Principles</h4>
<p><strong>JSON Communication</strong>: Using JSON format ensures reliable, structured communication between the SLM and the actuation system, reducing parsing errors.</p>
<p><strong>SLM-Driven Decisions</strong>: The SLM has complete control over LED decisions, demonstrating how AI can autonomously manage IoT systems.</p>
<p><strong>Configurable Threshold</strong>: The temperature threshold is a parameter that makes the system adaptable to different environments without code changes. Can be updated by the user.</p>
<p><strong>Clear Priority Rules</strong>: The system follows explicit priority rules that the SLM understands:</p>
<ul>
<li>Safety first (button press = emergency)</li>
<li>Then environmental warnings (temperature)</li>
<li>Then normal operation</li>
</ul>
<p>Now, this architecture showcases how Small Language Models can be integrated into IoT systems to provide intelligent, context-aware decision-making while maintaining simplicity and reliability.</p>
</section>
</section>
<section id="the-new-code" class="level3">
<h3 class="anchored" data-anchor-id="the-new-code">The new code</h3>
<div class="sourceCode" id="cb18"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> ollama</span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> json</span>
<span id="cb18-3"><a href="#cb18-3" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> monitor <span class="im">import</span> collect_data, led_status, control_leds</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="sourceCode" id="cb19"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> create_prompt(temp_dht, hum, temp_bmp, press, button_state, </span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a>                  ledRedSts, ledYlwSts, ledGrnSts, TEMP_THRESHOLD):</span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Create a prompt for the LLM with current sensor data."""</span></span>
<span id="cb19-4"><a href="#cb19-4" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="ss">f"""</span></span>
<span id="cb19-5"><a href="#cb19-5" aria-hidden="true" tabindex="-1"></a><span class="ss">        You are controlling an IoT LED system. Analyze the sensor data and decide </span></span>
<span id="cb19-6"><a href="#cb19-6" aria-hidden="true" tabindex="-1"></a><span class="ss">        which ONE LED to activate.</span></span>
<span id="cb19-7"><a href="#cb19-7" aria-hidden="true" tabindex="-1"></a><span class="ss">        </span></span>
<span id="cb19-8"><a href="#cb19-8" aria-hidden="true" tabindex="-1"></a><span class="ss">        SENSOR DATA:</span></span>
<span id="cb19-9"><a href="#cb19-9" aria-hidden="true" tabindex="-1"></a><span class="ss">        - DHT22 Temperature: </span><span class="sc">{</span>temp_dht<span class="sc">:.1f}</span><span class="ss">°C</span></span>
<span id="cb19-10"><a href="#cb19-10" aria-hidden="true" tabindex="-1"></a><span class="ss">        - BMP280 Temperature: </span><span class="sc">{</span>temp_bmp<span class="sc">:.1f}</span><span class="ss">°C</span></span>
<span id="cb19-11"><a href="#cb19-11" aria-hidden="true" tabindex="-1"></a><span class="ss">        - Humidity: </span><span class="sc">{</span>hum<span class="sc">:.1f}</span><span class="ss">%</span></span>
<span id="cb19-12"><a href="#cb19-12" aria-hidden="true" tabindex="-1"></a><span class="ss">        - Pressure: </span><span class="sc">{</span>press<span class="sc">:.2f}</span><span class="ss">hPa</span></span>
<span id="cb19-13"><a href="#cb19-13" aria-hidden="true" tabindex="-1"></a><span class="ss">        - Button: </span><span class="sc">{</span><span class="st">"PRESSED"</span> <span class="cf">if</span> button_state <span class="cf">else</span> <span class="st">"NOT PRESSED"</span><span class="sc">}</span></span>
<span id="cb19-14"><a href="#cb19-14" aria-hidden="true" tabindex="-1"></a><span class="ss">        </span></span>
<span id="cb19-15"><a href="#cb19-15" aria-hidden="true" tabindex="-1"></a><span class="ss">        TEMPERATURE THRESHOLD: </span><span class="sc">{</span>TEMP_THRESHOLD<span class="sc">}</span><span class="ss">°C</span></span>
<span id="cb19-16"><a href="#cb19-16" aria-hidden="true" tabindex="-1"></a><span class="ss">        </span></span>
<span id="cb19-17"><a href="#cb19-17" aria-hidden="true" tabindex="-1"></a><span class="ss">        DECISION RULES (apply in this priority order):</span></span>
<span id="cb19-18"><a href="#cb19-18" aria-hidden="true" tabindex="-1"></a><span class="ss">        1. IF button is PRESSED → Activate Red LED (EMERGENCY - highest priority)</span></span>
<span id="cb19-19"><a href="#cb19-19" aria-hidden="true" tabindex="-1"></a><span class="ss">        2. IF button is NOT PRESSED AND (DHT22 temp &gt; </span><span class="sc">{</span>TEMP_THRESHOLD<span class="sc">}</span><span class="ss">°C OR </span></span>
<span id="cb19-20"><a href="#cb19-20" aria-hidden="true" tabindex="-1"></a><span class="ss">        BMP280 temp &gt; </span><span class="sc">{</span>TEMP_THRESHOLD<span class="sc">}</span><span class="ss">°C) → Activate Yellow LED (WARNING)</span></span>
<span id="cb19-21"><a href="#cb19-21" aria-hidden="true" tabindex="-1"></a><span class="ss">        3. IF button is NOT PRESSED AND (DHT22 temp ≤ </span><span class="sc">{</span>TEMP_THRESHOLD<span class="sc">}</span><span class="ss">°C AND </span></span>
<span id="cb19-22"><a href="#cb19-22" aria-hidden="true" tabindex="-1"></a><span class="ss">        BMP280 temp ≤ </span><span class="sc">{</span>TEMP_THRESHOLD<span class="sc">}</span><span class="ss">°C) → Activate Green LED (NORMAL)</span></span>
<span id="cb19-23"><a href="#cb19-23" aria-hidden="true" tabindex="-1"></a><span class="ss">        </span></span>
<span id="cb19-24"><a href="#cb19-24" aria-hidden="true" tabindex="-1"></a><span class="ss">        CURRENT ANALYSIS:</span></span>
<span id="cb19-25"><a href="#cb19-25" aria-hidden="true" tabindex="-1"></a><span class="ss">        - Button status: </span><span class="sc">{</span><span class="st">"PRESSED"</span> <span class="cf">if</span> button_state <span class="cf">else</span> <span class="st">"NOT PRESSED"</span><span class="sc">}</span></span>
<span id="cb19-26"><a href="#cb19-26" aria-hidden="true" tabindex="-1"></a><span class="ss">        - DHT22 temp (</span><span class="sc">{</span>temp_dht<span class="sc">:.1f}</span><span class="ss">°C) is </span><span class="sc">{</span><span class="st">"OVER"</span> <span class="cf">if</span> temp_dht <span class="op">&gt;</span> TEMP_THRESHOLD </span>
<span id="cb19-27"><a href="#cb19-27" aria-hidden="true" tabindex="-1"></a>          <span class="cf">else</span> <span class="st">"AT OR BELOW"</span><span class="sc">}</span><span class="ss"> threshold (</span><span class="sc">{</span>TEMP_THRESHOLD<span class="sc">}</span><span class="ss">°C)</span></span>
<span id="cb19-28"><a href="#cb19-28" aria-hidden="true" tabindex="-1"></a><span class="ss">        - BMP280 temp (</span><span class="sc">{</span>temp_bmp<span class="sc">:.1f}</span><span class="ss">°C) is </span><span class="sc">{</span><span class="st">"OVER"</span> <span class="cf">if</span> temp_bmp <span class="op">&gt;</span> TEMP_THRESHOLD </span>
<span id="cb19-29"><a href="#cb19-29" aria-hidden="true" tabindex="-1"></a>          <span class="cf">else</span> <span class="st">"AT OR BELOW"</span><span class="sc">}</span><span class="ss"> threshold (</span><span class="sc">{</span>TEMP_THRESHOLD<span class="sc">}</span><span class="ss">°C)</span></span>
<span id="cb19-30"><a href="#cb19-30" aria-hidden="true" tabindex="-1"></a><span class="ss">        </span></span>
<span id="cb19-31"><a href="#cb19-31" aria-hidden="true" tabindex="-1"></a><span class="ss">        Based on these rules, respond with ONLY a JSON object (no other text):</span></span>
<span id="cb19-32"><a href="#cb19-32" aria-hidden="true" tabindex="-1"></a><span class="ss">        </span><span class="ch">{{</span><span class="ss">"red_led": true, "yellow_led": false, "green_led": false</span><span class="ch">}}</span></span>
<span id="cb19-33"><a href="#cb19-33" aria-hidden="true" tabindex="-1"></a><span class="ss">        </span></span>
<span id="cb19-34"><a href="#cb19-34" aria-hidden="true" tabindex="-1"></a><span class="ss">        Only ONE LED should be true, the other two must be false.</span></span>
<span id="cb19-35"><a href="#cb19-35" aria-hidden="true" tabindex="-1"></a><span class="ss">    """</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="sourceCode" id="cb20"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> parse_llm_response(response_text):</span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Parse the LLM JSON response to extract LED control instructions."""</span></span>
<span id="cb20-3"><a href="#cb20-3" aria-hidden="true" tabindex="-1"></a>    <span class="cf">try</span>:</span>
<span id="cb20-4"><a href="#cb20-4" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Clean the response - remove any markdown code blocks if present</span></span>
<span id="cb20-5"><a href="#cb20-5" aria-hidden="true" tabindex="-1"></a>        response_text <span class="op">=</span> response_text.strip()</span>
<span id="cb20-6"><a href="#cb20-6" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> response_text.startswith(<span class="st">'```'</span>):</span>
<span id="cb20-7"><a href="#cb20-7" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Extract JSON from markdown code block</span></span>
<span id="cb20-8"><a href="#cb20-8" aria-hidden="true" tabindex="-1"></a>            lines <span class="op">=</span> response_text.split(<span class="st">'</span><span class="ch">\n</span><span class="st">'</span>)</span>
<span id="cb20-9"><a href="#cb20-9" aria-hidden="true" tabindex="-1"></a>            response_text <span class="op">=</span> <span class="st">'</span><span class="ch">\n</span><span class="st">'</span>.join(lines[<span class="dv">1</span>:<span class="op">-</span><span class="dv">1</span>]) </span>
<span id="cb20-10"><a href="#cb20-10" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> <span class="bu">len</span>(lines) <span class="op">&gt;</span> <span class="dv">2</span> </span>
<span id="cb20-11"><a href="#cb20-11" aria-hidden="true" tabindex="-1"></a>            <span class="cf">else</span> response_text</span>
<span id="cb20-12"><a href="#cb20-12" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb20-13"><a href="#cb20-13" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Parse JSON</span></span>
<span id="cb20-14"><a href="#cb20-14" aria-hidden="true" tabindex="-1"></a>        data <span class="op">=</span> json.loads(response_text)</span>
<span id="cb20-15"><a href="#cb20-15" aria-hidden="true" tabindex="-1"></a>        red_led <span class="op">=</span> data.get(<span class="st">'red_led'</span>, <span class="va">False</span>)</span>
<span id="cb20-16"><a href="#cb20-16" aria-hidden="true" tabindex="-1"></a>        yellow_led <span class="op">=</span> data.get(<span class="st">'yellow_led'</span>, <span class="va">False</span>)</span>
<span id="cb20-17"><a href="#cb20-17" aria-hidden="true" tabindex="-1"></a>        green_led <span class="op">=</span> data.get(<span class="st">'green_led'</span>, <span class="va">False</span>)</span>
<span id="cb20-18"><a href="#cb20-18" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> (red_led, yellow_led, green_led)</span>
<span id="cb20-19"><a href="#cb20-19" aria-hidden="true" tabindex="-1"></a>    <span class="cf">except</span> (json.JSONDecodeError, <span class="pp">KeyError</span>) <span class="im">as</span> e:</span>
<span id="cb20-20"><a href="#cb20-20" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"Error parsing JSON response: </span><span class="sc">{</span>e<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb20-21"><a href="#cb20-21" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"Response was: </span><span class="sc">{</span>response_text<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb20-22"><a href="#cb20-22" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Fallback to safe state (all LEDs off)</span></span>
<span id="cb20-23"><a href="#cb20-23" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> (<span class="va">False</span>, <span class="va">False</span>, <span class="va">False</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="sourceCode" id="cb21"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> output_actuator(response, MODEL, temp_dht, hum, temp_bmp, </span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a>                    press, button_state):</span>
<span id="cb21-3"><a href="#cb21-3" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss">Smart IoT Actuator using </span><span class="sc">{</span>MODEL<span class="sc">}</span><span class="ss"> model</span><span class="ch">\n</span><span class="ss">"</span>)</span>
<span id="cb21-4"><a href="#cb21-4" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb21-5"><a href="#cb21-5" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"SYSTEM REAL DATA"</span>)</span>
<span id="cb21-6"><a href="#cb21-6" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f" - DHT22 ==&gt; Temp: </span><span class="sc">{</span>temp_dht<span class="sc">:.1f}</span><span class="ss">°C, Humidity: </span><span class="sc">{</span>hum<span class="sc">:.1f}</span><span class="ss">%"</span>)</span>
<span id="cb21-7"><a href="#cb21-7" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f" - BMP280 =&gt; Temp: </span><span class="sc">{</span>temp_bmp<span class="sc">:.1f}</span><span class="ss">°C, Pressure: </span><span class="sc">{</span>press<span class="sc">:.2f}</span><span class="ss">hPa"</span>)</span>
<span id="cb21-8"><a href="#cb21-8" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f" - Button </span><span class="sc">{</span><span class="st">'pressed'</span> <span class="cf">if</span> button_state <span class="cf">else</span> <span class="st">'not pressed'</span><span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb21-9"><a href="#cb21-9" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb21-10"><a href="#cb21-10" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss">&gt;&gt; </span><span class="sc">{</span>MODEL<span class="sc">}</span><span class="ss"> Response: </span><span class="sc">{</span>response[<span class="st">'response'</span>]<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb21-11"><a href="#cb21-11" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb21-12"><a href="#cb21-12" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Parse LLM response and use it directly (no validation)</span></span>
<span id="cb21-13"><a href="#cb21-13" aria-hidden="true" tabindex="-1"></a>    red, yellow, green <span class="op">=</span> parse_llm_response(response[<span class="st">'response'</span>])</span>
<span id="cb21-14"><a href="#cb21-14" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"&gt;&gt; SLM decision: Red=</span><span class="sc">{</span>red<span class="sc">}</span><span class="ss">, Yellow=</span><span class="sc">{</span>yellow<span class="sc">}</span><span class="ss">, Green=</span><span class="sc">{</span>green<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb21-15"><a href="#cb21-15" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb21-16"><a href="#cb21-16" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Control LEDs based on SLM decision</span></span>
<span id="cb21-17"><a href="#cb21-17" aria-hidden="true" tabindex="-1"></a>    control_leds(red, yellow, green)</span>
<span id="cb21-18"><a href="#cb21-18" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb21-19"><a href="#cb21-19" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss">SYSTEM ACTUATOR STATUS"</span>)</span>
<span id="cb21-20"><a href="#cb21-20" aria-hidden="true" tabindex="-1"></a>    ledRedSts, ledYlwSts, ledGrnSts  <span class="op">=</span> led_status()</span>
<span id="cb21-21"><a href="#cb21-21" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f" - Red LED </span><span class="sc">{</span><span class="st">'is on'</span> <span class="cf">if</span> ledRedSts <span class="cf">else</span> <span class="st">'is off'</span><span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb21-22"><a href="#cb21-22" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f" - Yellow LED </span><span class="sc">{</span><span class="st">'is on'</span> <span class="cf">if</span> ledYlwSts <span class="cf">else</span> <span class="st">'is off'</span><span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb21-23"><a href="#cb21-23" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f" - Green LED </span><span class="sc">{</span><span class="st">'is on'</span> <span class="cf">if</span> ledGrnSts <span class="cf">else</span> <span class="st">'is off'</span><span class="sc">}</span><span class="ss">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="sourceCode" id="cb22"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> slm_analyse_act(MODEL, TEMP_THRESHOLD):</span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Main function to get sensor data, run SLM inference, and actuate LEDs."""</span></span>
<span id="cb22-3"><a href="#cb22-3" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Get system info</span></span>
<span id="cb22-4"><a href="#cb22-4" aria-hidden="true" tabindex="-1"></a>    ledRedSts, ledYlwSts, ledGrnSts  <span class="op">=</span> led_status()</span>
<span id="cb22-5"><a href="#cb22-5" aria-hidden="true" tabindex="-1"></a>    temp_dht, hum, temp_bmp, press, button_state  <span class="op">=</span> collect_data()</span>
<span id="cb22-6"><a href="#cb22-6" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb22-7"><a href="#cb22-7" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Create prompt with current sensor data</span></span>
<span id="cb22-8"><a href="#cb22-8" aria-hidden="true" tabindex="-1"></a>    PROMPT <span class="op">=</span> create_prompt(temp_dht, </span>
<span id="cb22-9"><a href="#cb22-9" aria-hidden="true" tabindex="-1"></a>                           hum, </span>
<span id="cb22-10"><a href="#cb22-10" aria-hidden="true" tabindex="-1"></a>                           temp_bmp, </span>
<span id="cb22-11"><a href="#cb22-11" aria-hidden="true" tabindex="-1"></a>                           press, </span>
<span id="cb22-12"><a href="#cb22-12" aria-hidden="true" tabindex="-1"></a>                           button_state, </span>
<span id="cb22-13"><a href="#cb22-13" aria-hidden="true" tabindex="-1"></a>                           ledRedSts, </span>
<span id="cb22-14"><a href="#cb22-14" aria-hidden="true" tabindex="-1"></a>                           ledYlwSts, </span>
<span id="cb22-15"><a href="#cb22-15" aria-hidden="true" tabindex="-1"></a>                           ledGrnSts,</span>
<span id="cb22-16"><a href="#cb22-16" aria-hidden="true" tabindex="-1"></a>                           TEMP_THRESHOLD)</span>
<span id="cb22-17"><a href="#cb22-17" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb22-18"><a href="#cb22-18" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Analyse and actuate on LEDs</span></span>
<span id="cb22-19"><a href="#cb22-19" aria-hidden="true" tabindex="-1"></a>    response <span class="op">=</span> slm_inference(PROMPT, MODEL)</span>
<span id="cb22-20"><a href="#cb22-20" aria-hidden="true" tabindex="-1"></a>    output_actuator(response, MODEL, temp_dht, hum, temp_bmp, press, button_state)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="code-flow-diagram" class="level3">
<h3 class="anchored" data-anchor-id="code-flow-diagram">Code Flow Diagram</h3>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="./images/png/flow1.png" class="img-fluid figure-img" style="width:90.0%"></p>
</figure>
</div>
</section>
<section id="test1-temp-above-the-threshold" class="level3">
<h3 class="anchored" data-anchor-id="test1-temp-above-the-threshold">TEST1: Temp above the threshold</h3>
<section id="definitions" class="level4">
<h4 class="anchored" data-anchor-id="definitions">Definitions</h4>
<div class="sourceCode" id="cb23"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Model to be used</span></span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a>MODEL <span class="op">=</span> <span class="st">'llama3.2:3b'</span></span>
<span id="cb23-3"><a href="#cb23-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-4"><a href="#cb23-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Temperature threshold for warning</span></span>
<span id="cb23-5"><a href="#cb23-5" aria-hidden="true" tabindex="-1"></a>TEMP_THRESHOLD <span class="op">=</span> <span class="fl">20.0</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="calling-the-program" class="level4">
<h4 class="anchored" data-anchor-id="calling-the-program">Calling the program</h4>
<div class="sourceCode" id="cb24"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a>slm_analyse_act(MODEL, TEMP_THRESHOLD)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="result" class="level4">
<h4 class="anchored" data-anchor-id="result">Result</h4>
<div class="sourceCode" id="cb25"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a><span class="ex">Smart</span> IoT Actuator using llama3.2:3b model</span>
<span id="cb25-2"><a href="#cb25-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-3"><a href="#cb25-3" aria-hidden="true" tabindex="-1"></a><span class="ex">SYSTEM</span> REAL DATA</span>
<span id="cb25-4"><a href="#cb25-4" aria-hidden="true" tabindex="-1"></a> <span class="ex">-</span> DHT22 ==<span class="op">&gt;</span> Temp: 21.5°C, Humidity: 28.8%</span>
<span id="cb25-5"><a href="#cb25-5" aria-hidden="true" tabindex="-1"></a> <span class="ex">-</span> BMP280 =<span class="op">&gt;</span> Temp: 22.4°C, Pressure: 910.04hPa</span>
<span id="cb25-6"><a href="#cb25-6" aria-hidden="true" tabindex="-1"></a> <span class="ex">-</span> Button not pressed</span>
<span id="cb25-7"><a href="#cb25-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-8"><a href="#cb25-8" aria-hidden="true" tabindex="-1"></a><span class="op">&gt;&gt;</span> llama3.2:3b <span class="ex">Response:</span> {<span class="st">"red_led"</span>: false, <span class="st">"yellow_led"</span>: true, <span class="st">"green_led"</span>: false}</span>
<span id="cb25-9"><a href="#cb25-9" aria-hidden="true" tabindex="-1"></a><span class="op">&gt;&gt;</span> SLM <span class="ex">decision:</span> Red=False, Yellow=True, Green=False</span>
<span id="cb25-10"><a href="#cb25-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-11"><a href="#cb25-11" aria-hidden="true" tabindex="-1"></a><span class="ex">SYSTEM</span> ACTUATOR STATUS</span>
<span id="cb25-12"><a href="#cb25-12" aria-hidden="true" tabindex="-1"></a> <span class="ex">-</span> Red LED is off</span>
<span id="cb25-13"><a href="#cb25-13" aria-hidden="true" tabindex="-1"></a> <span class="ex">-</span> Yellow LED is on</span>
<span id="cb25-14"><a href="#cb25-14" aria-hidden="true" tabindex="-1"></a> <span class="ex">-</span> Green LED is off</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="./images/png/yellow.png" class="img-fluid figure-img" style="width:60.0%"></p>
</figure>
</div>
</section>
</section>
<section id="test2-temp-below-the-threshold" class="level3">
<h3 class="anchored" data-anchor-id="test2-temp-below-the-threshold">TEST2: Temp below the threshold</h3>
<div class="sourceCode" id="cb26"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Temperature threshold for warning</span></span>
<span id="cb26-2"><a href="#cb26-2" aria-hidden="true" tabindex="-1"></a>TEMP_THRESHOLD <span class="op">=</span> <span class="fl">25.0</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="sourceCode" id="cb27"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a>slm_analyse_act(MODEL, TEMP_THRESHOLD)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="sourceCode" id="cb28"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a><span class="ex">Smart</span> IoT Actuator using llama3.2:3b model</span>
<span id="cb28-2"><a href="#cb28-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-3"><a href="#cb28-3" aria-hidden="true" tabindex="-1"></a><span class="ex">SYSTEM</span> REAL DATA</span>
<span id="cb28-4"><a href="#cb28-4" aria-hidden="true" tabindex="-1"></a> <span class="ex">-</span> DHT22 ==<span class="op">&gt;</span> Temp: 21.6°C, Humidity: 29.1%</span>
<span id="cb28-5"><a href="#cb28-5" aria-hidden="true" tabindex="-1"></a> <span class="ex">-</span> BMP280 =<span class="op">&gt;</span> Temp: 22.4°C, Pressure: 910.07hPa</span>
<span id="cb28-6"><a href="#cb28-6" aria-hidden="true" tabindex="-1"></a> <span class="ex">-</span> Button not pressed</span>
<span id="cb28-7"><a href="#cb28-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-8"><a href="#cb28-8" aria-hidden="true" tabindex="-1"></a><span class="op">&gt;&gt;</span> llama3.2:3b <span class="ex">Response:</span> {<span class="st">"red_led"</span>: false, <span class="st">"yellow_led"</span>: false, <span class="st">"green_led"</span>: true}</span>
<span id="cb28-9"><a href="#cb28-9" aria-hidden="true" tabindex="-1"></a><span class="op">&gt;&gt;</span> SLM <span class="ex">decision:</span> Red=False, Yellow=False, Green=True</span>
<span id="cb28-10"><a href="#cb28-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-11"><a href="#cb28-11" aria-hidden="true" tabindex="-1"></a><span class="ex">SYSTEM</span> ACTUATOR STATUS</span>
<span id="cb28-12"><a href="#cb28-12" aria-hidden="true" tabindex="-1"></a> <span class="ex">-</span> Red LED is off</span>
<span id="cb28-13"><a href="#cb28-13" aria-hidden="true" tabindex="-1"></a> <span class="ex">-</span> Yellow LED is off</span>
<span id="cb28-14"><a href="#cb28-14" aria-hidden="true" tabindex="-1"></a> <span class="ex">-</span> Green LED is on</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="./images/png/green.png" class="img-fluid figure-img" style="width:60.0%"></p>
</figure>
</div>
</section>
<section id="test3-alarm-button-pressed" class="level3">
<h3 class="anchored" data-anchor-id="test3-alarm-button-pressed">TEST3: Alarm Button pressed</h3>
<div class="sourceCode" id="cb29"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a>slm_analyse_act(MODEL, TEMP_THRESHOLD)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="sourceCode" id="cb30"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a><span class="ex">Smart</span> IoT Actuator using llama3.2:3b model</span>
<span id="cb30-2"><a href="#cb30-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-3"><a href="#cb30-3" aria-hidden="true" tabindex="-1"></a><span class="ex">SYSTEM</span> REAL DATA</span>
<span id="cb30-4"><a href="#cb30-4" aria-hidden="true" tabindex="-1"></a> <span class="ex">-</span> DHT22 ==<span class="op">&gt;</span> Temp: 21.6°C, Humidity: 29.0%</span>
<span id="cb30-5"><a href="#cb30-5" aria-hidden="true" tabindex="-1"></a> <span class="ex">-</span> BMP280 =<span class="op">&gt;</span> Temp: 22.5°C, Pressure: 909.99hPa</span>
<span id="cb30-6"><a href="#cb30-6" aria-hidden="true" tabindex="-1"></a> <span class="ex">-</span> Button pressed</span>
<span id="cb30-7"><a href="#cb30-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-8"><a href="#cb30-8" aria-hidden="true" tabindex="-1"></a><span class="op">&gt;&gt;</span> llama3.2:3b <span class="ex">Response:</span> {<span class="st">"red_led"</span>: true, <span class="st">"yellow_led"</span>: false, <span class="st">"green_led"</span>: false}</span>
<span id="cb30-9"><a href="#cb30-9" aria-hidden="true" tabindex="-1"></a><span class="op">&gt;&gt;</span> SLM <span class="ex">decision:</span> Red=True, Yellow=False, Green=False</span>
<span id="cb30-10"><a href="#cb30-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-11"><a href="#cb30-11" aria-hidden="true" tabindex="-1"></a><span class="ex">SYSTEM</span> ACTUATOR STATUS</span>
<span id="cb30-12"><a href="#cb30-12" aria-hidden="true" tabindex="-1"></a> <span class="ex">-</span> Red LED is on</span>
<span id="cb30-13"><a href="#cb30-13" aria-hidden="true" tabindex="-1"></a> <span class="ex">-</span> Yellow LED is off</span>
<span id="cb30-14"><a href="#cb30-14" aria-hidden="true" tabindex="-1"></a> <span class="ex">-</span> Green LED is off</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="./images/png/red.png" class="img-fluid figure-img" style="width:60.0%"></p>
</figure>
</div>
</section>
</section>
<section id="interacting-with-iot-systems-using-natural-language-commands" class="level2">
<h2 class="anchored" data-anchor-id="interacting-with-iot-systems-using-natural-language-commands">Interacting with IoT Systems, using Natural Language Commands</h2>
<p>Now, let’s transform our IoT monitoring setup into an <strong>interactive assistant</strong> that accepts natural language commands and queries. Instead of autonomously monitoring conditions, the system will now respond to our requests in real-time.</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="./images/png/interactive_slm_system.png" class="img-fluid figure-img" style="width:90.0%"></p>
</figure>
</div>
<section id="what-will-change" class="level3">
<h3 class="anchored" data-anchor-id="what-will-change">What will change?</h3>
<section id="original-system-autonomous" class="level4">
<h4 class="anchored" data-anchor-id="original-system-autonomous"><a href="https://github.com/Mjrovai/EdgeML-with-Raspberry-Pi/blob/main/SLMs_for_IoT_CONTROL/slm_act_leds.py">Original System (Autonomous)</a></h4>
<ul>
<li>Continuously monitored sensors</li>
<li>Automatically decided LED states based on pre-defined rules</li>
<li>No user interaction</li>
</ul>
</section>
<section id="new-system-interactive" class="level4">
<h4 class="anchored" data-anchor-id="new-system-interactive"><a href="https://github.com/Mjrovai/EdgeML-with-Raspberry-Pi/blob/main/SLMs_for_IoT_CONTROL/slm_act_leds_interactive.py">New System (Interactive)</a></h4>
<ul>
<li>Waits for user commands</li>
<li>Accepts natural language queries and commands</li>
<li>Provides conversational responses</li>
<li>Executes actions based on user requests</li>
<li>Displays comprehensive system status</li>
</ul>
</section>
</section>
<section id="how-it-will-work" class="level3">
<h3 class="anchored" data-anchor-id="how-it-will-work">How It will Work</h3>
<section id="interactive-loop" class="level4">
<h4 class="anchored" data-anchor-id="interactive-loop">1. <strong>Interactive Loop</strong></h4>
<p>The system runs in a continuous loop:</p>
<pre><code>User Input → Sensor Reading → SLM Analysis → LED Control → Status Display → Wait for Next Input</code></pre>
</section>
<section id="dual-purpose-response" class="level4">
<h4 class="anchored" data-anchor-id="dual-purpose-response">2. <strong>Dual-Purpose Response</strong></h4>
<p>The SLM now returns a JSON object with TWO components:</p>
<div class="sourceCode" id="cb32"><pre class="sourceCode json code-with-copy"><code class="sourceCode json"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a><span class="fu">{</span></span>
<span id="cb32-2"><a href="#cb32-2" aria-hidden="true" tabindex="-1"></a>  <span class="dt">"message"</span><span class="fu">:</span> <span class="st">"Helpful text response to the user"</span><span class="fu">,</span></span>
<span id="cb32-3"><a href="#cb32-3" aria-hidden="true" tabindex="-1"></a>  <span class="dt">"leds"</span><span class="fu">:</span> <span class="fu">{</span></span>
<span id="cb32-4"><a href="#cb32-4" aria-hidden="true" tabindex="-1"></a>    <span class="dt">"red_led"</span><span class="fu">:</span> <span class="kw">false</span><span class="fu">,</span></span>
<span id="cb32-5"><a href="#cb32-5" aria-hidden="true" tabindex="-1"></a>    <span class="dt">"yellow_led"</span><span class="fu">:</span> <span class="kw">true</span><span class="fu">,</span></span>
<span id="cb32-6"><a href="#cb32-6" aria-hidden="true" tabindex="-1"></a>    <span class="dt">"green_led"</span><span class="fu">:</span> <span class="kw">false</span></span>
<span id="cb32-7"><a href="#cb32-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">}</span></span>
<span id="cb32-8"><a href="#cb32-8" aria-hidden="true" tabindex="-1"></a><span class="fu">}</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<ul>
<li><strong>message</strong>: What the assistant tells you (conversational response)</li>
<li><strong>leds</strong>: What the assistant does (LED control)</li>
</ul>
</section>
<section id="command-types" class="level4">
<h4 class="anchored" data-anchor-id="command-types">3. <strong>Command Types</strong></h4>
<p><strong>A. Information Queries</strong></p>
<p>Ask questions about sensor readings - LEDs remain unchanged.</p>
<p>Examples:</p>
<ul>
<li>“What’s the current temperature?”</li>
<li>“What are the actual conditions?”</li>
<li>“What’s the humidity level?”</li>
<li>“Is the button pressed?”</li>
</ul>
<p>Response format:</p>
<div class="sourceCode" id="cb33"><pre class="sourceCode json code-with-copy"><code class="sourceCode json"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a><span class="fu">{</span></span>
<span id="cb33-2"><a href="#cb33-2" aria-hidden="true" tabindex="-1"></a>  <span class="dt">"message"</span><span class="fu">:</span> <span class="st">"The current temperature is 21.5°C from DHT22 and 22.3°C from BMP280."</span><span class="fu">,</span></span>
<span id="cb33-3"><a href="#cb33-3" aria-hidden="true" tabindex="-1"></a>  <span class="dt">"leds"</span><span class="fu">:</span> <span class="fu">{</span><span class="dt">"red_led"</span><span class="fu">:</span> <span class="kw">false</span><span class="fu">,</span> <span class="dt">"yellow_led"</span><span class="fu">:</span> <span class="kw">true</span><span class="fu">,</span> <span class="dt">"green_led"</span><span class="fu">:</span> <span class="kw">false</span><span class="fu">}</span>  <span class="er">//</span> <span class="er">keeps</span> <span class="er">current</span> <span class="er">state</span></span>
<span id="cb33-4"><a href="#cb33-4" aria-hidden="true" tabindex="-1"></a><span class="fu">}</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p><strong>B. Direct LED Commands</strong></p>
<p>Tell the system which LEDs to turn on/off.</p>
<p>Examples:</p>
<ul>
<li>“Turn on the yellow LED”</li>
<li>“Turn on all LEDs”</li>
<li>“Turn off all LEDs”</li>
<li>“Turn on the red and green LEDs”</li>
</ul>
<p>Response format:</p>
<div class="sourceCode" id="cb34"><pre class="sourceCode json code-with-copy"><code class="sourceCode json"><span id="cb34-1"><a href="#cb34-1" aria-hidden="true" tabindex="-1"></a><span class="fu">{</span></span>
<span id="cb34-2"><a href="#cb34-2" aria-hidden="true" tabindex="-1"></a>  <span class="dt">"message"</span><span class="fu">:</span> <span class="st">"Yellow LED turned on."</span><span class="fu">,</span></span>
<span id="cb34-3"><a href="#cb34-3" aria-hidden="true" tabindex="-1"></a>  <span class="dt">"leds"</span><span class="fu">:</span> <span class="fu">{</span><span class="dt">"red_led"</span><span class="fu">:</span> <span class="kw">false</span><span class="fu">,</span> <span class="dt">"yellow_led"</span><span class="fu">:</span> <span class="kw">true</span><span class="fu">,</span> <span class="dt">"green_led"</span><span class="fu">:</span> <span class="kw">false</span><span class="fu">}</span></span>
<span id="cb34-4"><a href="#cb34-4" aria-hidden="true" tabindex="-1"></a><span class="fu">}</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p><strong>C. Conditional Commands</strong></p>
<p>Commands that depend on sensor readings or button state.</p>
<p>Examples:</p>
<ul>
<li>“If the temperature is above 20°C, turn on the yellow LED”</li>
<li>“If the button is pressed, turn on the red LED”</li>
<li>“If the button is not pressed, turn on the green LED”</li>
</ul>
<p>Response format:</p>
<div class="sourceCode" id="cb35"><pre class="sourceCode json code-with-copy"><code class="sourceCode json"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a><span class="fu">{</span></span>
<span id="cb35-2"><a href="#cb35-2" aria-hidden="true" tabindex="-1"></a>  <span class="dt">"message"</span><span class="fu">:</span> <span class="st">"Temperature is 21.5°C, which is above 20°C. Yellow LED turned on."</span><span class="fu">,</span></span>
<span id="cb35-3"><a href="#cb35-3" aria-hidden="true" tabindex="-1"></a>  <span class="dt">"leds"</span><span class="fu">:</span> <span class="fu">{</span><span class="dt">"red_led"</span><span class="fu">:</span> <span class="kw">false</span><span class="fu">,</span> <span class="dt">"yellow_led"</span><span class="fu">:</span> <span class="kw">true</span><span class="fu">,</span> <span class="dt">"green_led"</span><span class="fu">:</span> <span class="kw">false</span><span class="fu">}</span></span>
<span id="cb35-4"><a href="#cb35-4" aria-hidden="true" tabindex="-1"></a><span class="fu">}</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p><strong>D. Toggle/Switch Commands</strong></p>
<p>Commands that change LED states based on current conditions.</p>
<p>Examples:</p>
<ul>
<li>“If the button is pressed, switch the LED conditions”</li>
<li>“Toggle all LEDs”</li>
</ul>
<p>Response format:</p>
<div class="sourceCode" id="cb36"><pre class="sourceCode json code-with-copy"><code class="sourceCode json"><span id="cb36-1"><a href="#cb36-1" aria-hidden="true" tabindex="-1"></a><span class="fu">{</span></span>
<span id="cb36-2"><a href="#cb36-2" aria-hidden="true" tabindex="-1"></a>  <span class="dt">"message"</span><span class="fu">:</span> <span class="st">"Button is pressed. LED states switched."</span><span class="fu">,</span></span>
<span id="cb36-3"><a href="#cb36-3" aria-hidden="true" tabindex="-1"></a>  <span class="dt">"leds"</span><span class="fu">:</span> <span class="fu">{</span><span class="dt">"red_led"</span><span class="fu">:</span> <span class="kw">true</span><span class="fu">,</span> <span class="dt">"yellow_led"</span><span class="fu">:</span> <span class="kw">false</span><span class="fu">,</span> <span class="dt">"green_led"</span><span class="fu">:</span> <span class="kw">false</span><span class="fu">}</span>  <span class="er">//</span> <span class="er">inverted</span> <span class="er">from</span> <span class="er">current</span></span>
<span id="cb36-4"><a href="#cb36-4" aria-hidden="true" tabindex="-1"></a><span class="fu">}</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p><strong>E. Analysis Queries</strong></p>
<p>Ask the SLM to analyze sensor data.</p>
<p>Examples:</p>
<ul>
<li>“Based on the conditions, would we have rain?”</li>
<li>“Is the weather getting warmer?”</li>
<li>“What do the sensor readings indicate?”</li>
</ul>
<p>Response format:</p>
<div class="sourceCode" id="cb37"><pre class="sourceCode json code-with-copy"><code class="sourceCode json"><span id="cb37-1"><a href="#cb37-1" aria-hidden="true" tabindex="-1"></a><span class="fu">{</span></span>
<span id="cb37-2"><a href="#cb37-2" aria-hidden="true" tabindex="-1"></a>  <span class="dt">"message"</span><span class="fu">:</span> <span class="st">"Based on pressure of 910.18hPa and humidity of 28.8%, conditions are dry. Rain is unlikely. LEDs unchanged."</span><span class="fu">,</span></span>
<span id="cb37-3"><a href="#cb37-3" aria-hidden="true" tabindex="-1"></a>  <span class="dt">"leds"</span><span class="fu">:</span> <span class="fu">{</span><span class="dt">"red_led"</span><span class="fu">:</span> <span class="kw">false</span><span class="fu">,</span> <span class="dt">"yellow_led"</span><span class="fu">:</span> <span class="kw">false</span><span class="fu">,</span> <span class="dt">"green_led"</span><span class="fu">:</span> <span class="kw">true</span><span class="fu">}</span>  <span class="er">//</span> <span class="er">keeps</span> <span class="er">current</span> <span class="er">state</span></span>
<span id="cb37-4"><a href="#cb37-4" aria-hidden="true" tabindex="-1"></a><span class="fu">}</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
</section>
<section id="key-functions" class="level3">
<h3 class="anchored" data-anchor-id="key-functions">Key Functions</h3>
<section id="create_interactive_prompt" class="level5">
<h5 class="anchored" data-anchor-id="create_interactive_prompt"><code>create_interactive_prompt()</code></h5>
<ul>
<li>Creates a comprehensive prompt with:
<ul>
<li>Current sensor readings</li>
<li>Current LED states</li>
<li>User’s request</li>
<li>Examples of how to respond</li>
<li>Rules for the SLM to follow</li>
</ul></li>
</ul>
</section>
<section id="parse_interactive_response" class="level5">
<h5 class="anchored" data-anchor-id="parse_interactive_response"><code>parse_interactive_response()</code></h5>
<ul>
<li>Extracts the message from the SLM</li>
<li>Extracts the LED control commands</li>
<li>Handles JSON parsing errors gracefully</li>
</ul>
</section>
<section id="display_system_status" class="level5">
<h5 class="anchored" data-anchor-id="display_system_status"><code>display_system_status()</code></h5>
<ul>
<li>Shows comprehensive system status:
<ul>
<li>All sensor readings</li>
<li>Button state</li>
<li>LED states (with visual indicators ● ○)</li>
</ul></li>
</ul>
</section>
<section id="interactive_mode" class="level5">
<h5 class="anchored" data-anchor-id="interactive_mode"><code>interactive_mode()</code></h5>
<ul>
<li>Main loop that:
<ul>
<li>Accepts user input</li>
<li>Reads current sensor data</li>
<li>Sends request to SLM</li>
<li>Parses response</li>
<li>Controls LEDs</li>
<li>Displays results</li>
</ul></li>
</ul>
<blockquote class="blockquote">
<p>Here is the complete code: <a href="https://github.com/Mjrovai/EdgeML-with-Raspberry-Pi/blob/main/SLMs_for_IoT_CONTROL/slm_act_leds_interactive.py">slm_act_leds_interactive.py</a></p>
</blockquote>
</section>
</section>
<section id="running-the-system" class="level3">
<h3 class="anchored" data-anchor-id="running-the-system">Running the System</h3>
<div class="sourceCode" id="cb38"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb38-1"><a href="#cb38-1" aria-hidden="true" tabindex="-1"></a><span class="ex">python</span> slm_act_leds_interactive.py</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="tests" class="level3">
<h3 class="anchored" data-anchor-id="tests">Tests</h3>
<div class="sourceCode" id="cb39"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb39-1"><a href="#cb39-1" aria-hidden="true" tabindex="-1"></a><span class="ex">============================================================</span></span>
<span id="cb39-2"><a href="#cb39-2" aria-hidden="true" tabindex="-1"></a><span class="ex">IoT</span> Environmental Monitoring System <span class="at">-</span> Interactive Mode</span>
<span id="cb39-3"><a href="#cb39-3" aria-hidden="true" tabindex="-1"></a><span class="ex">Using</span> Model: llama3.2:3b</span>
<span id="cb39-4"><a href="#cb39-4" aria-hidden="true" tabindex="-1"></a><span class="ex">============================================================</span></span>
<span id="cb39-5"><a href="#cb39-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-6"><a href="#cb39-6" aria-hidden="true" tabindex="-1"></a><span class="ex">Commands</span> you can try:</span>
<span id="cb39-7"><a href="#cb39-7" aria-hidden="true" tabindex="-1"></a>  <span class="ex">-</span> What<span class="st">'s the current temperature?</span></span>
<span id="cb39-8"><a href="#cb39-8" aria-hidden="true" tabindex="-1"></a><span class="st">  - What are the actual conditions?</span></span>
<span id="cb39-9"><a href="#cb39-9" aria-hidden="true" tabindex="-1"></a><span class="st">  - Turn on the yellow LED</span></span>
<span id="cb39-10"><a href="#cb39-10" aria-hidden="true" tabindex="-1"></a><span class="st">  - If temperature is above 20°C, turn on yellow LED</span></span>
<span id="cb39-11"><a href="#cb39-11" aria-hidden="true" tabindex="-1"></a><span class="st">  - If button is pressed, turn on red LED</span></span>
<span id="cb39-12"><a href="#cb39-12" aria-hidden="true" tabindex="-1"></a><span class="st">  - Turn on all LEDs</span></span>
<span id="cb39-13"><a href="#cb39-13" aria-hidden="true" tabindex="-1"></a><span class="st">  - Turn off all LEDs</span></span>
<span id="cb39-14"><a href="#cb39-14" aria-hidden="true" tabindex="-1"></a><span class="st">  - Will it rain based on current conditions?</span></span>
<span id="cb39-15"><a href="#cb39-15" aria-hidden="true" tabindex="-1"></a><span class="st">  - Type '</span>status<span class="st">' to see system status</span></span>
<span id="cb39-16"><a href="#cb39-16" aria-hidden="true" tabindex="-1"></a><span class="st">  - Type '</span>exit<span class="st">' or '</span>quit<span class="st">' to stop</span></span>
<span id="cb39-17"><a href="#cb39-17" aria-hidden="true" tabindex="-1"></a><span class="st">============================================================</span></span>
<span id="cb39-18"><a href="#cb39-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-19"><a href="#cb39-19" aria-hidden="true" tabindex="-1"></a><span class="st">You: what'</span>s the current temperature<span class="pp">?</span></span>
<span id="cb39-20"><a href="#cb39-20" aria-hidden="true" tabindex="-1"></a><span class="ex">Assistant:</span> <span class="pp">[</span><span class="ss">Thinking...</span><span class="pp">]</span></span>
<span id="cb39-21"><a href="#cb39-21" aria-hidden="true" tabindex="-1"></a><span class="ex">Assistant:</span> The current temperature is 21.5°C from DHT22 and 22.3°C from BMP280.</span>
<span id="cb39-22"><a href="#cb39-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-23"><a href="#cb39-23" aria-hidden="true" tabindex="-1"></a><span class="ex">LED</span> Update: Red=OFF, Yellow=OFF, Green=ON</span>
<span id="cb39-24"><a href="#cb39-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-25"><a href="#cb39-25" aria-hidden="true" tabindex="-1"></a><span class="ex">You:</span> if temperature is above 20°C, turn on yellow LED</span>
<span id="cb39-26"><a href="#cb39-26" aria-hidden="true" tabindex="-1"></a><span class="ex">Assistant:</span> <span class="pp">[</span><span class="ss">Thinking...</span><span class="pp">]</span></span>
<span id="cb39-27"><a href="#cb39-27" aria-hidden="true" tabindex="-1"></a><span class="ex">Assistant:</span> Temperature is 21.5°C, which is above 20°C. Yellow LED turned on.</span>
<span id="cb39-28"><a href="#cb39-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-29"><a href="#cb39-29" aria-hidden="true" tabindex="-1"></a><span class="ex">LED</span> Update: Red=OFF, Yellow=ON, Green=OFF</span>
<span id="cb39-30"><a href="#cb39-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-31"><a href="#cb39-31" aria-hidden="true" tabindex="-1"></a><span class="ex">You:</span> will it rain<span class="pp">?</span></span>
<span id="cb39-32"><a href="#cb39-32" aria-hidden="true" tabindex="-1"></a><span class="ex">Assistant:</span> <span class="pp">[</span><span class="ss">Thinking...</span><span class="pp">]</span></span>
<span id="cb39-33"><a href="#cb39-33" aria-hidden="true" tabindex="-1"></a><span class="ex">Assistant:</span> Based on pressure of 910.18hPa and humidity of 28.8%, the air is </span>
<span id="cb39-34"><a href="#cb39-34" aria-hidden="true" tabindex="-1"></a><span class="ex">relatively</span> dry. Rain is unlikely in the immediate future. LEDs unchanged.</span>
<span id="cb39-35"><a href="#cb39-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-36"><a href="#cb39-36" aria-hidden="true" tabindex="-1"></a><span class="ex">LED</span> Update: Red=OFF, Yellow=ON, Green=OFF</span>
<span id="cb39-37"><a href="#cb39-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-38"><a href="#cb39-38" aria-hidden="true" tabindex="-1"></a><span class="ex">You:</span> status</span>
<span id="cb39-39"><a href="#cb39-39" aria-hidden="true" tabindex="-1"></a><span class="ex">============================================================</span></span>
<span id="cb39-40"><a href="#cb39-40" aria-hidden="true" tabindex="-1"></a><span class="ex">SYSTEM</span> STATUS</span>
<span id="cb39-41"><a href="#cb39-41" aria-hidden="true" tabindex="-1"></a><span class="ex">============================================================</span></span>
<span id="cb39-42"><a href="#cb39-42" aria-hidden="true" tabindex="-1"></a><span class="ex">DHT22</span> Sensor:  Temp = 21.5°C, Humidity = 28.8%</span>
<span id="cb39-43"><a href="#cb39-43" aria-hidden="true" tabindex="-1"></a><span class="ex">BMP280</span> Sensor: Temp = 22.3°C, Pressure = 910.18hPa</span>
<span id="cb39-44"><a href="#cb39-44" aria-hidden="true" tabindex="-1"></a><span class="ex">Button:</span>        NOT PRESSED</span>
<span id="cb39-45"><a href="#cb39-45" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-46"><a href="#cb39-46" aria-hidden="true" tabindex="-1"></a><span class="ex">LED</span> Status:</span>
<span id="cb39-47"><a href="#cb39-47" aria-hidden="true" tabindex="-1"></a>  <span class="ex">Red</span> LED:    ○ OFF</span>
<span id="cb39-48"><a href="#cb39-48" aria-hidden="true" tabindex="-1"></a>  <span class="ex">Yellow</span> LED: ● ON</span>
<span id="cb39-49"><a href="#cb39-49" aria-hidden="true" tabindex="-1"></a>  <span class="ex">Green</span> LED:  ○ OFF</span>
<span id="cb39-50"><a href="#cb39-50" aria-hidden="true" tabindex="-1"></a><span class="ex">============================================================</span></span>
<span id="cb39-51"><a href="#cb39-51" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-52"><a href="#cb39-52" aria-hidden="true" tabindex="-1"></a><span class="ex">You:</span> exit</span>
<span id="cb39-53"><a href="#cb39-53" aria-hidden="true" tabindex="-1"></a><span class="ex">Exiting</span> interactive mode. Goodbye!</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="special-commands" class="level3">
<h3 class="anchored" data-anchor-id="special-commands">Special Commands</h3>
<ul>
<li><strong><code>status</code></strong>: Display comprehensive system status without calling the SLM</li>
<li><strong><code>exit</code></strong> or <strong><code>quit</code></strong>: Exit the interactive mode</li>
</ul>
</section>
<section id="languages" class="level3">
<h3 class="anchored" data-anchor-id="languages">Languages</h3>
<p>One advantage of using SLMs is that, once multilingual models are used (as Llama 3,2 or Gemma), the user can choose the better language for them, independent of the language used during coding.</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="./images/png/multilingual.png" class="img-fluid figure-img" style="width:60.0%"></p>
</figure>
</div>
</section>
<section id="advantages-of-this-approach" class="level3">
<h3 class="anchored" data-anchor-id="advantages-of-this-approach">Advantages of This Approach</h3>
<ol type="1">
<li><strong>Natural Language Interface</strong>: Users don’t need to know programming or specific commands</li>
<li><strong>Flexible Control</strong>: Can handle complex conditional logic based on sensor data</li>
<li><strong>Informational</strong>: Can answer questions about the system without changing states</li>
<li><strong>Context-Aware</strong>: SLM understands current conditions and makes appropriate decisions</li>
<li><strong>Conversational</strong>: Provides helpful feedback about what it’s doing</li>
</ol>
</section>
<section id="error-handling" class="level3">
<h3 class="anchored" data-anchor-id="error-handling">Error Handling</h3>
<ul>
<li>If sensor data cannot be read, the system will notify you and wait for the next command</li>
<li>If the SLM response cannot be parsed, the system keeps LEDs in their current state</li>
</ul>
</section>
<section id="tips-for-best-results" class="level3">
<h3 class="anchored" data-anchor-id="tips-for-best-results">Tips for Best Results</h3>
<ol type="1">
<li><strong>Be specific</strong>: “Turn on the yellow LED” works better than “turn on the light”</li>
<li><strong>Use conditions clearly</strong>: “If temperature is above 20°C” is clearer than “when it’s hot”</li>
<li><strong>Ask for status</strong>: Use the <code>status</code> command frequently to verify system state</li>
<li><strong>One LED at a time</strong>: Unless you specifically say “all LEDs”, the system defaults to one LED on</li>
</ol>
</section>
<section id="flow-diagram" class="level3">
<h3 class="anchored" data-anchor-id="flow-diagram">Flow Diagram</h3>
<p><img src="./images/png/flow2.png" class="img-fluid"></p>
<blockquote class="blockquote">
<p>The development of our Interactive IoT-SLM system can also be followed using the Jupyter Notebook: <a href="https://github.com/Mjrovai/EdgeML-with-Raspberry-Pi/blob/main/SLMs_for_IoT_CONTROL/SLM_IoT.ipynb">SLM_IoT.ipynb</a>.</p>
</blockquote>
</section>
</section>
<section id="adding-data-logging" class="level2">
<h2 class="anchored" data-anchor-id="adding-data-logging">Adding Data Logging</h2>
<p>Now, we will develop an enhanced version that adds data logging, analysis, and historical query capabilities. The system automatically logs all sensor readings and commands, allowing it to analyze trends and query historical data using natural language.</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="./images/png/data_logging.png" class="img-fluid figure-img" style="width:90.0%"></p>
</figure>
</div>
<section id="key-features" class="level3">
<h3 class="anchored" data-anchor-id="key-features">Key Features</h3>
<section id="automatic-background-logging" class="level4">
<h4 class="anchored" data-anchor-id="automatic-background-logging">1. Automatic Background Logging</h4>
<ul>
<li>Logs sensor readings every 60 seconds</li>
<li>Runs in background thread</li>
<li>Stores data in CSV files</li>
</ul>
</section>
<section id="csv-data-storage" class="level4">
<h4 class="anchored" data-anchor-id="csv-data-storage">2. CSV Data Storage</h4>
<ul>
<li>sensor_readings.csv: All sensor data + LED states</li>
<li>command_history.csv: All commands and responses</li>
</ul>
</section>
<section id="statistical-analysis" class="level4">
<h4 class="anchored" data-anchor-id="statistical-analysis">3. Statistical Analysis</h4>
<ul>
<li>Min/max/average calculations</li>
<li>LED state change tracking</li>
<li>Button press counting</li>
<li>Trend analysis</li>
</ul>
</section>
<section id="natural-language-queries" class="level4">
<h4 class="anchored" data-anchor-id="natural-language-queries">4. Natural Language Queries</h4>
<p>Ask questions like:</p>
<ul>
<li>“Show me temperature trends for the last 24 hours”</li>
<li>“What was the average humidity today?”</li>
<li>“How many times was the button pressed?”</li>
</ul>
</section>
</section>
<section id="running-the-system-1" class="level3">
<h3 class="anchored" data-anchor-id="running-the-system-1">Running the System</h3>
<div class="sourceCode" id="cb40"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb40-1"><a href="#cb40-1" aria-hidden="true" tabindex="-1"></a><span class="ex">python</span> slm_act_leds_with_logging.py</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="example-queries" class="level3">
<h3 class="anchored" data-anchor-id="example-queries">Example Queries</h3>
<p><strong>Real-time:</strong></p>
<ul>
<li>“What’s the current temperature?”</li>
<li>“Turn on the yellow LED”</li>
</ul>
<p><strong>Historical:</strong></p>
<ul>
<li>“Show me temperature trends”</li>
<li>“What was the average humidity today?”</li>
<li>“How many times was the button pressed?”</li>
</ul>
<p><strong>Built-in commands:</strong></p>
<ul>
<li><code>status</code> - Show current system status</li>
<li><code>stats</code> - Show 24-hour statistics</li>
<li><code>exit</code> - Stop system</li>
</ul>
</section>
<section id="data-files" class="level3">
<h3 class="anchored" data-anchor-id="data-files">Data Files</h3>
</section>
<section id="sensor_readings.csv" class="level3">
<h3 class="anchored" data-anchor-id="sensor_readings.csv">sensor_readings.csv</h3>
<div class="sourceCode" id="cb41"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb41-1"><a href="#cb41-1" aria-hidden="true" tabindex="-1"></a><span class="ex">timestamp,temp_dht,humidity,temp_bmp,pressure,</span></span>
<span id="cb41-2"><a href="#cb41-2" aria-hidden="true" tabindex="-1"></a><span class="ex">button_pressed,red_led,yellow_led,green_led</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="command_history.csv" class="level3">
<h3 class="anchored" data-anchor-id="command_history.csv">command_history.csv</h3>
<div class="sourceCode" id="cb42"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb42-1"><a href="#cb42-1" aria-hidden="true" tabindex="-1"></a><span class="ex">timestamp,user_command,slm_response,red_led,yellow_led,green_led</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="tips" class="level3">
<h3 class="anchored" data-anchor-id="tips">Tips</h3>
<ol type="1">
<li>Let system run 1+ hour for meaningful trends</li>
<li>Use specific time frames: “last 6 hours”</li>
<li>Use <code>stats</code> command for quick overview</li>
<li>CSV files can be opened in Excel</li>
</ol>
<blockquote class="blockquote">
<p>The complete scripts for the datalogger version arehere: <a href="https://github.com/Mjrovai/EdgeML-with-Raspberry-Pi/blob/main/SLMs_for_IoT_CONTROL/data_logger.py">data_logger.py</a> and <a href="https://github.com/Mjrovai/EdgeML-with-Raspberry-Pi/blob/main/SLMs_for_IoT_CONTROL/slm_act_leds_with_logging.py">slm_act_leds_with_logging.py</a></p>
</blockquote>
</section>
<section id="flow-diagram-1" class="level3">
<h3 class="anchored" data-anchor-id="flow-diagram-1">Flow Diagram</h3>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="./images/png/flow3.png" class="img-fluid figure-img" style="width:90.0%"></p>
</figure>
</div>
</section>
</section>
<section id="prompt-optimization-and-efficiency" class="level2">
<h2 class="anchored" data-anchor-id="prompt-optimization-and-efficiency">Prompt Optimization and Efficiency</h2>
<p>We can modify for example the <code>interactive_mode(MODEL, USER_INPUT)</code> function, to include at its end, some statistics about the model’s performance:</p>
<div class="sourceCode" id="cb43"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb43-1"><a href="#cb43-1" aria-hidden="true" tabindex="-1"></a>...</span>
<span id="cb43-2"><a href="#cb43-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Display Latency</span></span>
<span id="cb43-3"><a href="#cb43-3" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss">Total Duration: </span><span class="sc">{</span>(response[<span class="st">'total_duration'</span>]<span class="op">/</span><span class="fl">1e9</span>)<span class="sc">:.2f}</span><span class="ss"> seconds"</span>)</span>
<span id="cb43-4"><a href="#cb43-4" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"prompt_eval_duration: </span><span class="sc">{</span>(response[<span class="st">'prompt_eval_duration'</span>]<span class="op">/</span><span class="fl">1e9</span>)<span class="sc">:.2f}</span><span class="ss"> s"</span>)</span>
<span id="cb43-5"><a href="#cb43-5" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"load_duration: </span><span class="sc">{</span>(response[<span class="st">'load_duration'</span>]<span class="op">/</span><span class="fl">1e9</span>)<span class="sc">:.2f}</span><span class="ss"> s"</span>)</span>
<span id="cb43-6"><a href="#cb43-6" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"eval_count: </span><span class="sc">{</span>response[<span class="st">'eval_count'</span>]<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb43-7"><a href="#cb43-7" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"eval_duration: </span><span class="sc">{</span>(response[<span class="st">'eval_duration'</span>]<span class="op">/</span><span class="fl">1e9</span>)<span class="sc">:.2f}</span><span class="ss"> s"</span>)</span>
<span id="cb43-8"><a href="#cb43-8" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"eval_rate: </span><span class="sc">{</span>response[<span class="st">'eval_count'</span>]<span class="op">/</span>(response[<span class="st">'eval_duration'</span>]<span class="op">/</span><span class="fl">1e9</span>)<span class="sc">:.2f}</span><span class="ss"> </span><span class="ch">\</span></span>
<span id="cb43-9"><a href="#cb43-9" aria-hidden="true" tabindex="-1"></a><span class="ss">tokens/s"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>For example, running</p>
<div class="sourceCode" id="cb44"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb44-1"><a href="#cb44-1" aria-hidden="true" tabindex="-1"></a>USER_INPUT <span class="op">=</span> <span class="st">"Turn off all LEDs"</span></span>
<span id="cb44-2"><a href="#cb44-2" aria-hidden="true" tabindex="-1"></a>interactive_mode(MODEL, USER_INPUT)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>We will get:</p>
<div class="sourceCode" id="cb45"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb45-1"><a href="#cb45-1" aria-hidden="true" tabindex="-1"></a><span class="ex">Total</span> Duration: 88.81 seconds</span>
<span id="cb45-2"><a href="#cb45-2" aria-hidden="true" tabindex="-1"></a><span class="ex">prompt_eval_duration:</span> 80.41 s</span>
<span id="cb45-3"><a href="#cb45-3" aria-hidden="true" tabindex="-1"></a><span class="ex">load_duration:</span> 1.98 s</span>
<span id="cb45-4"><a href="#cb45-4" aria-hidden="true" tabindex="-1"></a><span class="ex">eval_count:</span> 32</span>
<span id="cb45-5"><a href="#cb45-5" aria-hidden="true" tabindex="-1"></a><span class="ex">eval_duration:</span> 6.41 s</span>
<span id="cb45-6"><a href="#cb45-6" aria-hidden="true" tabindex="-1"></a><span class="ex">eval_rate:</span> 4.99 tokens/s</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Based on the <code>prompt_eval_duration</code> value, the <code>PROMPT</code> is our main bottleneck, so we must make it as concise as possible. The SLM must process all of the context <em>before</em> it can generate the first output token.</p>
<section id="quick-solution" class="level3">
<h3 class="anchored" data-anchor-id="quick-solution">Quick Solution:</h3>
<section id="drastically-shorten-the-prompt" class="level4">
<h4 class="anchored" data-anchor-id="drastically-shorten-the-prompt">1. Drastically Shorten the Prompt</h4>
<ul>
<li><p><strong>Condense System Status:</strong> Remove unnecessary descriptive text and present the status information in a compact, structured format.</p>
<ul>
<li><p><strong>Example (Before):</strong></p>
<div class="sourceCode" id="cb46"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb46-1"><a href="#cb46-1" aria-hidden="true" tabindex="-1"></a>CURRENT SYSTEM STATUS:</span>
<span id="cb46-2"><a href="#cb46-2" aria-hidden="true" tabindex="-1"></a><span class="op">-</span> DHT22: Temperature <span class="fl">25.5</span>°C, Humidity <span class="fl">45.1</span><span class="op">%</span></span>
<span id="cb46-3"><a href="#cb46-3" aria-hidden="true" tabindex="-1"></a><span class="op">-</span> BMP280: Temperature <span class="fl">25.6</span>°C, Pressure <span class="fl">1012.34</span><span class="er">hPa</span></span>
<span id="cb46-4"><a href="#cb46-4" aria-hidden="true" tabindex="-1"></a><span class="op">-</span> Button: NOT PRESSED</span>
<span id="cb46-5"><a href="#cb46-5" aria-hidden="true" tabindex="-1"></a><span class="op">-</span> Red LED: OFF</span>
<span id="cb46-6"><a href="#cb46-6" aria-hidden="true" tabindex="-1"></a><span class="op">-</span> Yellow LED: OFF</span>
<span id="cb46-7"><a href="#cb46-7" aria-hidden="true" tabindex="-1"></a><span class="op">-</span> Green LED: ON</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div></li>
<li><p><strong>Example (After):</strong></p>
<div class="sourceCode" id="cb47"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb47-1"><a href="#cb47-1" aria-hidden="true" tabindex="-1"></a>STATUS: DHT22<span class="op">=</span><span class="fl">22.5</span>°C<span class="op">/</span><span class="fl">65.0</span><span class="op">%</span> BMP280<span class="op">=</span><span class="fl">22.3</span>°C<span class="op">/</span><span class="fl">1013.25</span><span class="er">hPa</span> Button<span class="op">=</span>OFF LEDs:R<span class="op">=</span>OFF<span class="op">/</span>Y<span class="op">=</span>ON<span class="op">/</span>G<span class="op">=</span>OFF</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div></li>
</ul></li>
<li><p><strong>Reduce Examples:</strong> While examples are crucial for instruction-following, <strong>eliminate redundancy</strong>. Keep only the most diverse and representative examples. The current prompt is very long due to verbose examples and instructions. <strong>Focus on the single-shot example</strong> that shows the <em>required JSON output format</em>.</p></li>
<li><p><strong>Simplify Instructions:</strong> Make the instructions as direct and short as possible. Use keywords instead of full sentences where clarity is maintained.</p></li>
<li><p><strong>System message</strong>: It defines the assistant’s behavior and should sent once at initialization, not at PROMPT</p>
<div class="sourceCode" id="cb48"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb48-1"><a href="#cb48-1" aria-hidden="true" tabindex="-1"></a>SYSTEM_MESSAGE <span class="op">=</span> <span class="st">"""You are an IoT assistant controlling an environmental </span></span>
<span id="cb48-2"><a href="#cb48-2" aria-hidden="true" tabindex="-1"></a><span class="st">monitoring system with LEDs.</span></span>
<span id="cb48-3"><a href="#cb48-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-4"><a href="#cb48-4" aria-hidden="true" tabindex="-1"></a><span class="st">Respond with JSON only:</span></span>
<span id="cb48-5"><a href="#cb48-5" aria-hidden="true" tabindex="-1"></a><span class="st">{"message": "your helpful response", "leds": {"red_led": bool, "yellow_led": </span></span>
<span id="cb48-6"><a href="#cb48-6" aria-hidden="true" tabindex="-1"></a><span class="st">bool, "green_led": bool</span><span class="sc">}}</span></span>
<span id="cb48-7"><a href="#cb48-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-8"><a href="#cb48-8" aria-hidden="true" tabindex="-1"></a><span class="st">RULES:</span></span>
<span id="cb48-9"><a href="#cb48-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-10"><a href="#cb48-10" aria-hidden="true" tabindex="-1"></a><span class="st">- Information queries: keep current LED states unchanged</span></span>
<span id="cb48-11"><a href="#cb48-11" aria-hidden="true" tabindex="-1"></a><span class="st">- LED commands: update LEDs as requested</span></span>
<span id="cb48-12"><a href="#cb48-12" aria-hidden="true" tabindex="-1"></a><span class="st">- Conditional commands (if/when): evaluate condition from sensor data first</span></span>
<span id="cb48-13"><a href="#cb48-13" aria-hidden="true" tabindex="-1"></a><span class="st">- Only ONE LED should be on at a time UNLESS user explicitly says "all"</span></span>
<span id="cb48-14"><a href="#cb48-14" aria-hidden="true" tabindex="-1"></a><span class="st">- Be concise and conversational</span></span>
<span id="cb48-15"><a href="#cb48-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-16"><a href="#cb48-16" aria-hidden="true" tabindex="-1"></a><span class="st">Always respond with valid JSON containing both "message" and "leds" fields."""</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div></li>
</ul>
</section>
<section id="chat-api-instead-of-generate" class="level4">
<h4 class="anchored" data-anchor-id="chat-api-instead-of-generate">2. <code>chat</code> API Instead of <code>generate</code></h4>
<ul>
<li>Uses <code>ollama.chat()</code> to maintain conversation context</li>
<li>System message sent only once at initialization</li>
<li>Subsequent messages are much shorter (only status + user query)</li>
</ul>
</section>
<section id="smart-context-management" class="level4">
<h4 class="anchored" data-anchor-id="smart-context-management">Smart Context Management</h4>
<ul>
<li>Keeps last four conversation exchanges (8 messages) + system message</li>
<li>Prevents context from growing too large over time</li>
</ul>
</section>
<section id="model-pre-loading" class="level4">
<h4 class="anchored" data-anchor-id="model-pre-loading">Model Pre-loading</h4>
<ul>
<li>Loads model into memory before first query</li>
<li>Eliminates the 2-second load delay on first run</li>
</ul>
<p>Let’s re-create the functions or add new as bellow:</p>
</section>
</section>
<section id="new-code" class="level3">
<h3 class="anchored" data-anchor-id="new-code">New Code</h3>
<section id="original-functions" class="level4">
<h4 class="anchored" data-anchor-id="original-functions">Original Functions:</h4>
<ul>
<li><p><strong><code>create_interactive_prompt()</code></strong> - Now creates compact user messages (was ~800 tokens, now ~100 tokens)</p></li>
<li><p><strong><code>slm_inference()</code></strong> - Now uses <code>ollama.chat()</code> API instead of <code>ollama.generate()</code></p></li>
<li><p><strong><code>parse_interactive_response()</code></strong> - Unchanged</p></li>
<li><p><strong><code>display_system_status()</code></strong> - Unchanged</p></li>
<li><p><strong><code>interactive_mode()</code></strong> - Updated with all optimizations</p></li>
</ul>
</section>
<section id="new-functions" class="level4">
<h4 class="anchored" data-anchor-id="new-functions">New functions:</h4>
<ul>
<li><p><strong><code>SYSTEM_MESSAGE</code></strong> - Constant for system prompt (sent only once)</p></li>
<li><p><strong><code>preload_model()</code></strong> - Helper to pre-load model into memory</p></li>
</ul>
</section>
</section>
<section id="key-changes-under-the-hood" class="level3">
<h3 class="anchored" data-anchor-id="key-changes-under-the-hood">Key Changes Under the Hood:</h3>
<ol type="1">
<li><strong><code>create_interactive_prompt()</code></strong> now returns a compact format:
<ul>
<li>Before: Long prompt with 8 examples (~800 tokens)</li>
<li>After: Compact status line + user input (~100 tokens)</li>
</ul></li>
<li><strong><code>slm_inference()</code></strong> now uses chat API:
<ul>
<li>Before: <code>ollama.generate(model, prompt)</code> - regenerates context each time</li>
<li>After: <code>ollama.chat(model, messages)</code> - maintains conversation context</li>
</ul></li>
<li><strong>System prompt is sent only once</strong> at initialization, not with every query</li>
</ol>
<p>Using the optimized code: slm_act_leds_interactive_optimized.py, we get as a response:</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="./images/png/optimized-response.png" class="img-fluid figure-img" style="width:80.0%"></p>
</figure>
</div>
<p>The Prompt evaluation time was reduced drastically!</p>
</section>
<section id="using-pydantic" class="level3">
<h3 class="anchored" data-anchor-id="using-pydantic">Using Pydantic</h3>
<p>Using <strong>Pydantic</strong> is a robust way to improve the reliability, efficiency, and maintainability of our system, mainly since we rely on the LLM to output precise JSON.</p>
<p>Here’s how Pydantic can help and what you would need to do:</p>
<section id="how-pydantic-reduces-latency-and-improves-reliability" class="level4">
<h4 class="anchored" data-anchor-id="how-pydantic-reduces-latency-and-improves-reliability">1. How Pydantic Reduces Latency and Improves Reliability</h4>
<p>Pydantic doesn’t directly speed up the model’s token generation, but it can <strong>indirectly reduce latency</strong> and <strong>eliminate error-handling overhead</strong> by enabling cleaner, faster parsing and more robust communication.</p>
<section id="a.-reliable-and-fast-json-parsing" class="level5">
<h5 class="anchored" data-anchor-id="a.-reliable-and-fast-json-parsing">A. <strong>Reliable and Fast JSON Parsing</strong></h5>
<p>The most critical benefit is moving from the general, potentially brittle <code>json.loads(response_text)</code> in our <code>parse_interactive_response</code> function to Pydantic’s fast validation engine.</p>
<ul>
<li><strong>Pydantic’s JSON Parsing is C-Accelerated:</strong> Pydantic is built on top of the fast <code>pydantic-core</code> library written in Rust, which is significantly faster than Python’s standard <code>json</code> module, especially for large or complex data structures.</li>
<li><strong>Structured Output:</strong> Our current code manually handles potential JSON formatting issues (such as the <code>jsoncode block delimiters</code>) and then uses a <code>try/except</code> block to extract fields. Pydantic handles all of this automatically and throws a clean error if the structure is wrong.</li>
</ul>
</section>
<section id="b.-stronger-instruction-for-the-slm" class="level5">
<h5 class="anchored" data-anchor-id="b.-stronger-instruction-for-the-slm">B. <strong>Stronger Instruction for the SLM</strong></h5>
<p>The model is more likely to generate the <em>exact</em> JSON required when you give it a formal schema to follow.</p>
<ul>
<li><strong>JSON Schema:</strong> Pydantic can generate a <strong>JSON Schema</strong> from your Python classes. We can include this schema directly in our prompt, which acts as an unambiguous, machine-readable instruction for the SLM. This often leads to fewer errors in the model’s output, reducing the need for costly retries or complex string manipulation.</li>
</ul>
</section>
<section id="c.-cleaner-python-code" class="level5">
<h5 class="anchored" data-anchor-id="c.-cleaner-python-code">C. <strong>Cleaner Python Code</strong></h5>
<p>It simplifies our <code>parse_interactive_response</code> function immensely, making your code easier to read and debug.</p>
</section>
</section>
</section>
<section id="implementing-pydantic-in-the-code" class="level3">
<h3 class="anchored" data-anchor-id="implementing-pydantic-in-the-code">2. Implementing Pydantic in the Code</h3>
<blockquote class="blockquote">
<p>Let’s test it on the Optimized Interactive version: <code>slm_act_leds_optimized.py</code></p>
</blockquote>
<p>We cshould modify the workflow in three main steps:</p>
<section id="step-1-define-the-pydantic-models" class="level4">
<h4 class="anchored" data-anchor-id="step-1-define-the-pydantic-models">Step 1: Define the Pydantic Models</h4>
<p>We must replace the implicit structure with explicit Pydantic models:</p>
<div class="sourceCode" id="cb49"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb49-1"><a href="#cb49-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> pydantic <span class="im">import</span> BaseModel, Field</span>
<span id="cb49-2"><a href="#cb49-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-3"><a href="#cb49-3" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> LEDControl(BaseModel):</span>
<span id="cb49-4"><a href="#cb49-4" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""LED control configuration."""</span></span>
<span id="cb49-5"><a href="#cb49-5" aria-hidden="true" tabindex="-1"></a>    red_led: <span class="bu">bool</span> <span class="op">=</span> Field(description<span class="op">=</span><span class="st">"Red LED state (on/off)"</span>)</span>
<span id="cb49-6"><a href="#cb49-6" aria-hidden="true" tabindex="-1"></a>    yellow_led: <span class="bu">bool</span> <span class="op">=</span> Field(description<span class="op">=</span><span class="st">"Yellow LED state (on/off)"</span>)</span>
<span id="cb49-7"><a href="#cb49-7" aria-hidden="true" tabindex="-1"></a>    green_led: <span class="bu">bool</span> <span class="op">=</span> Field(description<span class="op">=</span><span class="st">"Green LED state (on/off)"</span>)</span>
<span id="cb49-8"><a href="#cb49-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-9"><a href="#cb49-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-10"><a href="#cb49-10" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> AssistantResponse(BaseModel):</span>
<span id="cb49-11"><a href="#cb49-11" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Complete assistant response with message and LED control."""</span></span>
<span id="cb49-12"><a href="#cb49-12" aria-hidden="true" tabindex="-1"></a>    message: <span class="bu">str</span> <span class="op">=</span> Field(description<span class="op">=</span><span class="st">"Helpful response to the user"</span>)</span>
<span id="cb49-13"><a href="#cb49-13" aria-hidden="true" tabindex="-1"></a>    leds: LEDControl <span class="op">=</span> Field(description<span class="op">=</span><span class="st">"LED control configuration"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="step-2-update-the-slm-inference-function" class="level4">
<h4 class="anchored" data-anchor-id="step-2-update-the-slm-inference-function">Step 2: Update the SLM inference function</h4>
<p>We would update the <code>create_interactive_prompt</code> to include the schema:</p>
<div class="sourceCode" id="cb50"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb50-1"><a href="#cb50-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> slm_inference(messages, MODEL):</span>
<span id="cb50-2"><a href="#cb50-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Send chat request to Ollama using chat API with structured output </span></span>
<span id="cb50-3"><a href="#cb50-3" aria-hidden="true" tabindex="-1"></a><span class="co">    (Pydantic)."""</span></span>
<span id="cb50-4"><a href="#cb50-4" aria-hidden="true" tabindex="-1"></a>    response <span class="op">=</span> ollama.chat(</span>
<span id="cb50-5"><a href="#cb50-5" aria-hidden="true" tabindex="-1"></a>        model<span class="op">=</span>MODEL,</span>
<span id="cb50-6"><a href="#cb50-6" aria-hidden="true" tabindex="-1"></a>        messages<span class="op">=</span>messages,</span>
<span id="cb50-7"><a href="#cb50-7" aria-hidden="true" tabindex="-1"></a>        <span class="bu">format</span><span class="op">=</span>AssistantResponse.model_json_schema()  <span class="co"># Using Pydantic schema</span></span>
<span id="cb50-8"><a href="#cb50-8" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb50-9"><a href="#cb50-9" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> response</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="step-3-update-the-parsing-function" class="level4">
<h4 class="anchored" data-anchor-id="step-3-update-the-parsing-function">Step 3: Update the Parsing Function</h4>
<p>Our <code>parse_interactive_response</code> becomes much cleaner and more reliable:</p>
<div class="sourceCode" id="cb51"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb51-1"><a href="#cb51-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> parse_interactive_response(response_text):</span>
<span id="cb51-2"><a href="#cb51-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Parse the interactive SLM response using Pydantic (guaranteed valid)."""</span></span>
<span id="cb51-3"><a href="#cb51-3" aria-hidden="true" tabindex="-1"></a>    <span class="cf">try</span>:</span>
<span id="cb51-4"><a href="#cb51-4" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Parse directly into Pydantic model - guaranteed valid JSON structure</span></span>
<span id="cb51-5"><a href="#cb51-5" aria-hidden="true" tabindex="-1"></a>        data <span class="op">=</span> AssistantResponse.model_validate_json(response_text)</span>
<span id="cb51-6"><a href="#cb51-6" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb51-7"><a href="#cb51-7" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Extract values from Pydantic model</span></span>
<span id="cb51-8"><a href="#cb51-8" aria-hidden="true" tabindex="-1"></a>        message <span class="op">=</span> data.message</span>
<span id="cb51-9"><a href="#cb51-9" aria-hidden="true" tabindex="-1"></a>        red_led <span class="op">=</span> data.leds.red_led</span>
<span id="cb51-10"><a href="#cb51-10" aria-hidden="true" tabindex="-1"></a>        yellow_led <span class="op">=</span> data.leds.yellow_led</span>
<span id="cb51-11"><a href="#cb51-11" aria-hidden="true" tabindex="-1"></a>        green_led <span class="op">=</span> data.leds.green_led</span>
<span id="cb51-12"><a href="#cb51-12" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb51-13"><a href="#cb51-13" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> message, (red_led, yellow_led, green_led)</span>
<span id="cb51-14"><a href="#cb51-14" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb51-15"><a href="#cb51-15" aria-hidden="true" tabindex="-1"></a>    <span class="cf">except</span> <span class="pp">Exception</span> <span class="im">as</span> e:</span>
<span id="cb51-16"><a href="#cb51-16" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"Error parsing response: </span><span class="sc">{</span>e<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb51-17"><a href="#cb51-17" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"Response was: </span><span class="sc">{</span>response_text<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb51-18"><a href="#cb51-18" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="st">"Error: Could not parse SLM response."</span>, (<span class="va">False</span>, <span class="va">False</span>, <span class="va">False</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>With such modifications, the final latency was reduced from 90 to around 60 seconds</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="./images/png/pydantic-optim.png" class="img-fluid figure-img" style="width:80.0%"></p>
</figure>
</div>
<p>Note that when we sent two different commands to turn on the LEDs, the new one did not turn off the previous one. This is due to the change in the rules. If we want, we can modify it to match whatever we wish to.</p>
<blockquote class="blockquote">
<p>The final code can be found on GitHub: <a href="https://github.com/Mjrovai/EdgeML-with-Raspberry-Pi/blob/main/SLMs_for_IoT_CONTROL/slm_act_leds_interactive_pydantic.py">slm_act_leds_interactive_pydantic.py</a> and in notebook <a href="https://github.com/Mjrovai/EdgeML-with-Raspberry-Pi/blob/main/SLMs_for_IoT_CONTROL/SLM_IoT.ipynb">SLM_IoT.ipynb</a></p>
</blockquote>
<p>In short, using Pydantic over tradicional approuch with JSON, we have as benefits:</p>
<ul>
<li><strong>No more parsing errors</strong> - Guaranteed valid JSON</li>
<li><strong>Cleaner output</strong> - No markdown code blocks</li>
<li><strong>Type safety</strong> - IDE autocomplete and type checking</li>
<li><strong>Faster generation</strong> - Constrained decoding is more efficient</li>
<li><strong>Better validation</strong> - Pydantic catches invalid values</li>
</ul>
</section>
</section>
</section>
<section id="next-steps" class="level2">
<h2 class="anchored" data-anchor-id="next-steps">Next Steps</h2>
<p>This chapter involved experimenting with simple applications and verifying the feasibility of using an SLM to control IoT devices. The final result is far from usable in the real world, but it can serve as a starting point for more interesting applications. Below are some observations and suggestions for improvement:</p>
<ul>
<li><p>SLM responses can be probabilistic and inconsistent. To increase reliability, consider implementing a confidence threshold or voting system using multiple prompts/responses.</p></li>
<li><p>Try to add data validation and sanity checks for sensor readings before passing them to the SLM.</p></li>
<li><p>Apply <strong>Structured Response Parsing</strong> as discussed early. Future improvements in this approuch could include:</p>
<ul>
<li>Add more sophisticated validation rules</li>
<li>Implement command history tracking</li>
<li>Add support for compound commands</li>
<li>Integrate with the logging system</li>
<li>Add user permission levels</li>
<li>Implement command templates for common operations</li>
</ul></li>
<li><p>Consider implementing a fallback mechanism when SLM responses are ambiguous or inconsistent.</p></li>
<li><p>Study using RAG and fine-tuning to increase the system’s reliability when using very small models.</p></li>
<li><p>Consider adding input validation for user commands to prevent potential issues.</p></li>
<li><p>The current implementation queries the SLM for every command. We did it to study how SLMs would behave. We should consider implementing a caching mechanism for common queries.</p></li>
<li><p>Some simple commands could be handled without SLM intervention. We can do it programmatically.</p></li>
<li><p>Consider implementing a proper state machine for LED control to ensure consistent behavior.</p></li>
<li><p>Implement more sophisticated trend analysis using statistical methods.</p></li>
<li><p>Add support for more complex queries combining multiple data points.</p></li>
</ul>
</section>
<section id="conclusion" class="level1">
<h1>Conclusion</h1>
<p>This chapter has demonstrated the progressive evolution of an IoT system from basic sensor integration to an intelligent, interactive platform powered by Small Language Models. Through our journey, we’ve explored several key aspects of combining edge AI with physical computing:</p>
<section id="key-achievements" class="level4">
<h4 class="anchored" data-anchor-id="key-achievements">Key Achievements</h4>
<ol type="1">
<li><strong>Progressive System Development</strong>
<ul>
<li>Started with basic sensor integration and LED control</li>
<li>Advanced to SLM-based analysis and decision making</li>
<li>Implemented natural language interaction</li>
<li>Added historical data logging and analysis</li>
<li>Created a complete interactive system</li>
</ul></li>
<li><strong>SLM Integration Insights</strong>
<ul>
<li>Demonstrated the feasibility of using SLMs for IoT control</li>
<li>Explored different models and their capabilities</li>
<li>Implemented various prompting strategies</li>
<li>Handled both real-time and historical data analysis</li>
</ul></li>
<li><strong>Practical Learning Outcomes</strong>
<ul>
<li>Hardware-software integration techniques</li>
<li>Real-time sensor data processing</li>
<li>Natural language command interpretation</li>
<li>Data logging and trend analysis</li>
<li>Error handling and system reliability</li>
</ul></li>
</ol>
</section>
<section id="challenges-and-limitations" class="level4">
<h4 class="anchored" data-anchor-id="challenges-and-limitations">Challenges and Limitations</h4>
<p>Our implementation revealed several important challenges:</p>
<ol type="1">
<li><strong>SLM Reliability</strong>
<ul>
<li>Probabilistic nature of responses</li>
<li>Consistency issues in decision making</li>
<li>Need for better validation and verification</li>
</ul></li>
<li><strong>System Performance</strong>
<ul>
<li>Response time considerations</li>
<li>Resource usage on edge devices</li>
<li>Efficiency of data logging and analysis</li>
</ul></li>
<li><strong>Architectural Constraints</strong>
<ul>
<li>Simple state management</li>
<li>Basic error handling</li>
<li>Limited data validation</li>
</ul></li>
</ol>
</section>
<section id="final-thoughts" class="level4">
<h4 class="anchored" data-anchor-id="final-thoughts">Final Thoughts</h4>
<p>While this implementation demonstrates the potential of combining SLMs with IoT systems, it also highlights the exciting possibilities and challenges ahead. Though experimental, the system we’ve built provides a solid foundation for understanding how edge AI can enhance IoT applications. As SLMs evolve and improve, their integration with physical computing systems will likely become more robust and practical for real-world applications.</p>
<p>This chapter has shown that, despite current limitations, SLMs can provide intelligent, natural-language interfaces to IoT systems, opening new possibilities for human-machine interaction in the physical world.</p>
<p>The future of IoT systems is shaped by intelligent, edge-based solutions that combine AI’s power with the practicality of physical computing.</p>
</section>
<section id="resourses" class="level2">
<h2 class="anchored" data-anchor-id="resourses">Resourses</h2>
<ul>
<li><a href="https://github.com/Mjrovai/EdgeML-with-Raspberry-Pi/tree/main/SLMs_for_IoT_CONTROL">Python Scripts and notebook</a></li>
</ul>


</section>
</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
      var filterRegex = new RegExp('/' + window.location.host + '/');
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
          // target, if specified
          link.setAttribute("target", "_blank");
          // default icon
          link.classList.add("external");
      }
    }
});
</script>
<nav class="page-navigation">
  <div class="nav-page nav-page-previous">
      <a href="../../raspi/physical_comp/RPi_Physical_Computing.html" class="pagination-link">
        <i class="bi bi-arrow-left-short"></i> <span class="nav-page-text">Physical Computing with Raspberry Pi</span>
      </a>          
  </div>
  <div class="nav-page nav-page-next">
      <a href="../../raspi/advancing_adgeai/adv_edgeai.html" class="pagination-link">
        <span class="nav-page-text">Advancing EdgeAI: Beyond Basic SLMs</span> <i class="bi bi-arrow-right-short"></i>
      </a>
  </div>
</nav>
</div> <!-- /content -->
<footer class="footer">
  <div class="nav-footer">
    <div class="nav-footer-left">Written and edited by Prof.&nbsp;Marcelo Rovai (UNIFEI University)</div>   
    <div class="nav-footer-center">
      &nbsp;
    </div>
    <div class="nav-footer-right">This book was built with <a href="https://quarto.org/">Quarto</a>.</div>
  </div>
</footer>



</body></html>